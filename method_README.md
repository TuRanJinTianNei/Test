# method.m - OFDM信号识别和子载波检测功能说明文档

## 概述

`method.m` 是一个完整的OFDM信号识别和带宽检测仿真程序，实现了在Rayleigh多径衰落信道环境下使用两种功率谱密度（PSD）估计方法来估算OFDM信号带宽的功能。

**主要功能**：
1. OFDM信号生成（基带信号）
2. Rayleigh多径衰落信道建模
3. 带宽检测率计算（不同SNR下）
4. 功率谱密度估计和可视化
5. 性能对比分析

**两种带宽估计方法**：
1. **Welch算法**（周期图平均法）
2. **AR模型法**（自回归模型，使用Burg算法）

---

## 独立性说明

本文件可以**独立运行**，不依赖其他函数文件。所有需要的自定义函数都在文件内部定义，包括：

- `PSD_generate`：OFDM信号生成
- `Bandwidth_rate_rayleigh`：Rayleigh信道带宽检测率计算
- `PSD_OFDM_rayleigh`：功率谱密度估计
- `MUL_RAYLEIGH`：多径瑞利衰落信道
- `Burg`：AR模型功率谱估计
- `Proximate`：近似查找函数
- 以及其他辅助函数

---

## 运行要求

### MATLAB工具箱

- **MATLAB基础环境**
- **通信工具箱**（Communications Toolbox）
  - `qammod`：QAM调制
  - `awgn`：加性高斯白噪声
- **信号处理工具箱**（Signal Processing Toolbox）
  - `pwelch`：Welch算法功率谱估计
  - `hanning`：汉宁窗函数
  - `freqz`：频率响应计算

### 使用方法

直接在MATLAB命令窗口运行：

```matlab
method
```

或：

```matlab
run('method.m')
```

---

## 信号参数

### 信号类型说明

**重要**：信号在不同处理阶段的类型不同：

| 处理阶段 | 信号类型 | 说明 |
|---------|---------|------|
| **基带信号**（`PSD_generate`输出） | **复信号** | 包含实部和虚部，QAM调制后的复数基带信号 |
| **上变频后** | **复信号** | 乘以复指数`exp(1j*2*pi*fc/fs*t)`后仍为复数 |
| **Rayleigh信道后** | **实信号** | 通过`real()`函数取实部，转换为实数信号 |
| **最终用于带宽估计** | **实信号** | 经过Rayleigh信道和AWGN噪声后的实数信号 |

**信号处理流程**：
```matlab
% 1. 生成复基带信号
sig_ofdm = PSD_generate(N);  % 复信号（有实部和虚部）

% 2. 上变频（仍为复信号）
sig_upconverted = sig_ofdm .* exp(1j*2*pi*fc/fs*(0:length(sig_ofdm)-1));  % 复信号

% 3. 通过Rayleigh信道并取实部（转换为实信号）
sig_rayleigh = real(MUL_RAYLEIGH(sig_upconverted, ...));  % 实信号

% 4. 加AWGN噪声（实信号）
sig_final = awgn(sig_rayleigh, snr, 'measured');  % 实信号
```

**为什么取实部**：
- 在实际通信系统中，经过上变频和信道后，通常只传输实信号（I路或Q路）
- 取实部后信号变为实数，便于后续的功率谱估计和带宽计算
- 实信号的功率谱密度估计更符合实际应用场景

---

### OFDM信号参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **OFDM符号数量** | `N` | 20 | 一个帧结构中OFDM信号的个数 |
| **数据子载波数** | `para` | 128 | 带内数据子载波数量（有效数据长度） |
| **调制方式** | `M` | 16 | QAM调制阶数（16-QAM） |
| **过采样倍数** | - | 4 | IFFT前的过采样倍数 |
| **循环前缀比例** | `ratio` | 1/4 | 循环前缀长度与有效数据长度的比例 |
| **过渡窗长度** | - | 符号长度的5% | 符号间平滑过渡的窗长度（最小20个点） |
| **理想带宽** | `B_ideal` | 8 MHz | OFDM信号的理想带宽值 |

**计算说明**：
- 有效数据长度（IFFT点数）：`para × 4 = 512` 点
- 循环前缀长度：`512 × (1/4) = 128` 点
- 单个OFDM符号长度：`512 + 128 = 640` 点
- 总信号长度：`640 × N` 点（考虑窗函数重叠）

### 系统参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **载波频率** | `fc` | 10 MHz | 信号的载波频率 |
| **采样频率** | `fs` | 40 MHz | 采样频率（4倍载波频率） |
| **采样间隔** | `Ts` | 25 ns | 采样时间间隔（1/fs） |
| **频率分辨率** | - | - | 由FFT点数和采样频率决定 |

**频率关系**：
- 基带带宽：0 ~ 8 MHz
- 载波后带宽：`fc ± 4 MHz` = 6 ~ 14 MHz
- 奈奎斯特频率：`fs/2 = 20 MHz`

### 信道参数

#### Rayleigh多径衰落信道

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **多径数** | `n1` | 6 | 多径衰落路径总数 |
| **多径延时** | `itau` | [0, 400, 800, 2000, 8000, 20000] 样本 | 每条路径的延时（样本数） |
| **多径延时（时间）** | `tau` | [0, 10, 20, 50, 200, 500] ns | 每条路径的延时（纳秒） |
| **多径功率** | `power` | [0, -1.0, -7.0, -10.0, -12.0, -17.0] dB | 每条路径的功率衰减（相对于主径） |
| **最大多普勒频率** | `fmax` | 20 Hz | 最大多普勒频移 |
| **瑞利信道记录次数** | `itn` | [10000, 20000, 30000, 40000, 50000, 60000] | 每条路径的衰落计数器 |

**多径延时详细说明**：
- 路径1：0 样本（0 ns）- 主径，功率 0 dB
- 路径2：400 样本（10 ns）- 功率 -1.0 dB
- 路径3：800 样本（20 ns）- 功率 -7.0 dB
- 路径4：2000 样本（50 ns）- 功率 -10.0 dB
- 路径5：8000 样本（200 ns）- 功率 -12.0 dB
- 路径6：20000 样本（500 ns）- 功率 -17.0 dB

**多径延时计算**：
```matlab
itau = floor([0, 1e-8, 2e-8, 5e-8, 2e-7, 5e-7] * fs);
% 转换为时间：tau = itau / fs
```

#### AWGN噪声

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **信噪比范围** | `snr` | -4:2:20 dB | 信噪比范围（-4到20dB，步长2dB） |
| **SNR点数** | - | 13 | 共13个SNR测试点 |
| **噪声类型** | - | AWGN | 加性高斯白噪声 |

**SNR测试点**：-4, -2, 0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20 dB

### 功率谱估计参数

#### Welch算法参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **窗函数** | - | Hanning窗 | 窗函数类型 |
| **窗长度** | - | 100 样本 | 窗函数长度 |
| **重叠样本数** | - | 55 样本 | 段间重叠样本数（约55%重叠） |
| **FFT点数** | `N_FFT` | 8192 | FFT点数（4096×2） |
| **频率分辨率** | `Δf` | 4.88 kHz | `fs / N_FFT` |
| **带宽阈值** | - | -3 dB | 固定阈值（功率下降一半） |

#### AR模型参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **阶数选择准则** | - | AIC | Akaike信息准则 |
| **最大阶数** | `p_max` | N/3 | 不超过信号长度的1/3 |
| **频率采样点数** | `N_freq` | 200,000 | 频率响应采样点数 |
| **频率分辨率** | `Δf` | 200 Hz | `fs / N_freq` |
| **带宽阈值** | - | 自适应 | 根据SNR选择：<br>- SNR > 4 dB：-6 dB<br>- 0 < SNR ≤ 4 dB：-5 dB<br>- SNR ≤ 0 dB：-3 dB |

### 蒙特卡洛仿真参数

| 参数 | 符号 | 默认值 | 说明 |
|------|------|--------|------|
| **重复次数** | `numb` | 1 | 每个SNR值的蒙特卡洛仿真次数 |
| **统计方法** | - | 平均 | 对多次仿真结果取平均 |

**注意**：默认每个SNR值只仿真1次。如需提高统计可靠性，可修改`Bandwidth_rate_rayleigh`函数中的`numb`参数。

### 信号长度计算

**单个OFDM符号**：
- 有效数据长度：`512` 点（IFFT点数）
- 循环前缀长度：`128` 点
- 符号总长度：`640` 点
- 符号时长：`640 / fs = 16 μs`

**完整信号**（N=20个符号）：
- 理论长度：`640 × 20 = 12,800` 点
- 实际长度：由于窗函数重叠，实际长度略小于理论值
- 信号时长：约 `320 μs`（取决于窗函数重叠）

**采样点数和时长关系**：
- 采样点数 = 信号时长 × 采样频率
- 信号时长 = 采样点数 / 采样频率

---

## 程序结构

### 主要流程

```
1. 初始化参数
   ├── OFDM符号数量 N = 20
   ├── 载波频率 fc = 10 MHz
   ├── 采样频率 fs = 40 MHz
   ├── 信噪比范围 SNR = [-4:2:20] dB
   └── Rayleigh信道参数（多径延时、功率、多普勒频率等）

2. 生成OFDM基带信号（复信号）
   └── PSD_generate(N) → 输出复基带信号

3. 绘制原始信号图形（复信号）
   ├── 时域波形（实部和虚部）
   └── 频域频谱（双边和单边）

4. 信号处理：上变频 → Rayleigh信道 → 取实部 → 加噪声
   ├── 上变频：复信号 × exp(1j*2*pi*fc/fs*t) → 仍为复信号
   ├── Rayleigh信道：MUL_RAYLEIGH(...) → 复信号
   ├── 取实部：real(...) → 转换为实信号
   └── 加AWGN噪声：awgn(...) → 实信号

5. 绘制输入信号图形（实信号，经过Rayleigh信道）
   ├── 时域波形（实数）
   └── 频域频谱（单边）

6. 计算Rayleigh信道带宽检测率（使用实信号）
   └── Bandwidth_rate_rayleigh(...)
       ├── 对每个SNR值进行多次仿真
       ├── 使用Welch算法估计带宽（输入：实信号）
       └── 使用AR模型法估计带宽（输入：实信号）

7. 生成PSD图形（SNR=20dB，实信号）
   └── PSD_OFDM_rayleigh(..., snr=20, k=1)

8. 绘制带宽检测率对比图
   └── 显示AR模型法和Welch算法的性能对比
```

---

## 主要函数说明

### 1. PSD_generate

**功能**：生成用于测试的OFDM基带信号

**参数**：
- `N`：一个帧结构中OFDM信号的个数

**特点**：
- 使用16-QAM调制
- 128个带内数据子载波
- 4倍过采样
- 循环前缀比例：1/4
- 使用窗函数实现符号间平滑过渡，避免频谱泄露

**输出**：
- `sig_chnl`：归一化的OFDM基带信号（行向量）

### 2. Bandwidth_rate_rayleigh

**功能**：计算Rayleigh信道下不同SNR的带宽检测率

**参数**：
- `sig1_chnl`：OFDM基带信号
- `fc`：载波频率（Hz）
- `fs`：采样频率（Hz）
- `snr`：信噪比向量（dB）
- `itau`：多径延时（样本数）
- `power`：多径功率（dB）
- `fmax`：最大多普勒频率（Hz）
- `itn`：瑞利信道记录次数

**输出**：
- `B_rate_welch`：Welch算法的带宽检测率（百分比）
- `B_rate_ar`：AR模型法的带宽检测率（百分比）

**计算过程**：
1. 对每个SNR值进行蒙特卡洛仿真（默认1次）
2. 调用`PSD_OFDM_rayleigh`估计带宽
3. 计算检测率：`1 - |B_estimated - B_ideal| / B_ideal`
4. 输出详细的误差统计信息

### 3. PSD_OFDM_rayleigh

**功能**：在Rayleigh信道下估计OFDM信号的带宽

**参数**：
- `sig1_chnl`：OFDM基带信号（**复信号**，输入）
- `fc`：载波频率（Hz）
- `fs`：采样频率（Hz）
- `snr`：信噪比（dB，标量）
- `k`：绘图标志（k=1时绘制PSD图）
- `itau`：多径延时
- `power`：多径功率
- `fmax`：最大多普勒频率
- `itn`：瑞利信道记录次数

**信号处理流程**（信号类型变化）：
```matlab
% 1. 上变频：将基带信号上变频到载波频率fc（复信号 → 复信号）
sig3_chnl = (sig1_chnl.*exp(1j*2*pi*fc/fs*(0:length(sig1_chnl)-1)));
% 此时 sig3_chnl 仍为复信号

% 2. 通过瑞利衰落信道并取实部（复信号 → 实信号）
sig3_chnl = real(MUL_RAYLEIGH(sig3_chnl,itau,power,itn,...));
% 使用 real() 函数取实部，sig3_chnl 变为实信号

% 3. 添加AWGN噪声（实信号 → 实信号）
sig3_chnl = awgn(sig3_chnl,snr,'measured');
% 最终 sig3_chnl 为实信号，用于带宽估计
```

**信号类型**：
- **输入**：`sig1_chnl` 为复基带信号
- **中间处理**：上变频后仍为复信号
- **关键转换**：通过`real()`函数取实部，转换为实信号
- **最终输出**：用于带宽估计的`sig3_chnl`为**实信号**

**输出**：
- `B_welch`：Welch算法估计的带宽（Hz）
- `B_ar`：AR模型法估计的带宽（Hz）

**注意**：如果存在`estimateBandwidthPSD.m`工具函数，会优先使用该函数进行带宽估计。

### 4. MUL_RAYLEIGH

**功能**：模拟多径瑞利衰落信道

**参数**：
- `x`：输入基带数据
- `itau`：每条路径的延时时间
- `dlvl`：每条路径的衰减电平（dB）
- `itn`：每条路径的衰落计数器
- `n1`：路径总数
- `nsamp`：总样本数
- `tstp`：最小时间分辨率
- `fd`：最大多普勒频率
- `flat`：平坦衰落标志（1=仅幅度波动，0=幅度和相位都波动）

**输出**：
- `xout`：经过多径衰落的输出信号

---

## 方法一：Welch算法（周期图平均法）

### 原理

Welch算法是一种改进的周期图方法，通过以下步骤降低功率谱估计的方差：

1. **分段**：将信号分成多个重叠的段
2. **加窗**：对每段信号应用窗函数（减少频谱泄漏）
3. **FFT**：对每段进行FFT变换，得到周期图
4. **平均**：对所有段的周期图进行平均，得到最终的功率谱估计

### 实现代码

```matlab
[Pxx2, f1] = pwelch(sig3_chnl, hanning(100), 55, 4096*2, fs);
```

**参数说明**：
- `sig3_chnl`：输入信号（**实信号**，经过上变频、瑞利衰落取实部和加噪声处理）
- `hanning(100)`：汉宁窗，窗长度为100个样本
- `55`：重叠样本数（overlap），约55%重叠
- `4096*2`：FFT点数（8192点），决定频率分辨率
- `fs`：采样频率（40 MHz）

**输出**：
- `Pxx2`：功率谱密度估计值（线性单位）
- `f1`：对应的频率向量（Hz）

### 功率谱归一化处理

```matlab
Pxx22 = Pxx2;
Pxx22 = Pxx22/min(Pxx22);        % 归一化到最小值
Pxx22 = 10*log10(Pxx22);          % 转换为dB单位
Pxx22 = Pxx22 - max(Pxx22);       % 归一化到最大值（峰值在0dB）
```

### 带宽计算

Welch算法使用**固定阈值法**计算带宽：

```matlab
% 将功率谱分成前后两半
L1 = ceil(length(Pxx22)/2);
P1 = Pxx22(1:L1,1);      % 前半部分（低频）
P2 = Pxx22(L1:end,1);    % 后半部分（高频）

% 在前半部分找到最接近-3dB的点（下边界）
[as1, as11] = Proximate(-3, P1);
band1 = f1(as1);

% 在后半部分找到最接近-3dB的点（上边界）
[as2, as22] = Proximate(-3, P2);
band2 = f1(as2+L1-1);

% 带宽 = 上边界 - 下边界
B_welch = abs(band1 - band2);
```

**关键点**：
- 使用**-3dB阈值**（功率下降一半的位置）
- 分别在前半部分和后半部分查找阈值点
- 带宽 = 上边界频率 - 下边界频率

### 优点
- 计算速度快
- 对噪声有较好的鲁棒性
- 实现简单，MATLAB内置函数

### 缺点
- 频率分辨率受窗长度限制
- 需要选择合适的窗函数和重叠率

---

## 方法二：AR模型法（自回归模型）

### 原理

AR（Auto-Regressive）模型将信号建模为：

\[
x(n) = -\sum_{k=1}^{p} a_k x(n-k) + e(n)
\]

其中：
- \(p\)：模型阶数
- \(a_k\)：AR模型系数
- \(e(n)\)：白噪声激励

通过估计AR模型参数，可以计算功率谱密度：

\[
P_{AR}(f) = \frac{\sigma^2}{|1 + \sum_{k=1}^{p} a_k e^{-j2\pi fk}|^2}
\]

其中\(\sigma^2\)是激励噪声的方差。

### 实现代码

#### 1. 模型阶数选择（AIC准则）

```matlab
[Pxx1, f, p] = Burg(sig3_chnl, fs, 'AIC');
```

**AIC（Akaike Information Criterion）准则**：
\[
AIC(p) = N \ln(E_p) + 2p
\]

其中：
- \(N\)：信号长度
- \(E_p\)：p阶AR模型的预测误差功率
- \(p\)：模型阶数

选择使AIC最小的阶数作为最优模型阶数。

#### 2. Burg算法估计AR参数

Burg算法通过最小化前向和后向预测误差的几何平均来估计反射系数：

```matlab
function [a, E] = computeARpara(x, p)
    % 初始化
    ef = x;  % 前向预测误差
    eb = x;  % 后向预测误差
    a = 1;   % AR模型系数（初始为1）
    
    for m = 1:p
        % 计算反射系数
        efm = ef(2:end);
        ebm = eb(1:end-1);
        k(m) = -2 * (ebm' * efm) / (efm' * efm + ebm' * ebm);
        
        % 更新预测误差
        ef = efm + k(m) * ebm;
        eb = ebm + conj(k(m)) * efm;
        
        % 更新AR系数
        a = [a; 0] + k(m) * [0; conj(flipud(a))];
        
        % 更新误差功率
        E(m+1) = (1 - abs(k(m))^2) * E(m);
    end
end
```

#### 3. 功率谱计算

```matlab
[h, f] = freqz(1, a, 20e5, Fs);              % 计算频率响应
psdviaBurg = E(end) * abs(h).^2 / Fs;       % 计算功率谱
psdviaBurg = psdviaBurg / abs(max(psdviaBurg));  % 归一化
psdviaBurg = 10*log10(abs(psdviaBurg));      % 转换为dB
```

**参数说明**：
- `freqz(1, a, 20e5, Fs)`：计算AR模型的频率响应
  - `1`：分子多项式（全通）
  - `a`：分母多项式（AR系数）
  - `20e5`：频率采样点数（200,000点，高分辨率）
  - `Fs`：采样频率

### 带宽计算

AR模型法使用**自适应阈值法**，根据SNR动态选择阈值：

```matlab
% 将功率谱分成前后两半
L2 = ceil(length(Pxx1)/2);
P3 = Pxx1(1:L2,1);      % 前半部分（低频）
P4 = Pxx1(L2:end,1);    % 后半部分（高频）

% 根据SNR选择阈值
if snr > 4
    threshold = -6;      % 高SNR：使用-6dB阈值
elseif snr > 0 && snr <= 4
    threshold = -5;      % 中等SNR：使用-5dB阈值
else
    threshold = -3;      % 低SNR：使用-3dB阈值
end

% 在前半部分找到最接近阈值的点（下边界）
[as3, as33] = Proximate(threshold, P3);
band3 = f(as3);

% 在后半部分找到最接近阈值的点（上边界）
[as4, as44] = Proximate(threshold, P4);
band4 = f(as4+L2-1);

% 带宽 = 上边界 - 下边界
B_ar = abs(band4 - band3);
```

**关键点**：
- **自适应阈值**：根据SNR动态调整（-6dB/-5dB/-3dB）
- SNR越高，使用更严格的阈值（-6dB），可以获得更精确的带宽估计
- SNR越低，使用更宽松的阈值（-3dB），避免噪声影响

### 优点
- 频率分辨率高（不受窗长度限制）
- 对短数据序列效果好
- 可以自适应选择模型阶数

### 缺点
- 计算复杂度较高
- 需要估计模型阶数
- 对模型阶数选择敏感

---

## 两种方法的对比

| 特性 | Welch算法 | AR模型法 |
|------|-----------|----------|
| **频率分辨率** | 受窗长度限制 | 高分辨率（可达200,000点） |
| **计算速度** | 快 | 较慢 |
| **阈值选择** | 固定-3dB | 自适应（-6dB/-5dB/-3dB） |
| **噪声鲁棒性** | 较好（通过平均降低方差） | 中等（依赖模型阶数） |
| **实现复杂度** | 低（MATLAB内置函数） | 高（需要实现Burg算法） |
| **适用场景** | 长信号、实时处理 | 短信号、高精度需求 |

---

## 辅助函数说明

### Proximate函数

用于查找数组中与目标值最接近的元素位置：

```matlab
function [as1, as11] = Proximate(b, aa)
    a = aa(:);                          % 转换为一维数组
    ab = (a(:) - b)';                   % 计算差值
    abc = abs(ab);                      % 取绝对值
    abc = sort(abc);                    % 排序
    [as1, as11] = find(abs((a(:) - b)) == abc(1,1));  % 找到最接近的位置
end
```

**用途**：在功率谱中找到最接近阈值（如-3dB、-5dB、-6dB）的频率点。

---

## 输出结果

### 1. 控制台输出

程序运行时会输出详细的进度信息和统计结果：

```
========================================
OFDM信号识别和子载波检测仿真开始
========================================
开始时间: 2025-12-10 10:00:00

========== 仿真参数 ==========
OFDM符号数量 N = 20
载波频率 fc = 1.00e+07 Hz (10.00 MHz)
采样频率 fs = 4.00e+07 Hz (40.00 MHz)
信噪比范围 SNR = [-4:2:20] dB
最大多普勒频率 fmax = 20 Hz
多径延时 itau = [0 400 800 2000 8000 20000] 样本
多径功率 power = [0 -1 -7 -10 -12 -17] dB
================================

开始生成 OFDM 信号...
OFDM 信号生成完成！耗时: X.XX 秒

正在计算 Rayleigh 信道带宽检测率...
总进度: 0/13 SNR 值
参数: 每个SNR值重复 1 次
Rayleigh信道参数: fmax=20.0 Hz, 多径数=6
  处理 SNR = -4.0 dB (1/13)...
  完成 SNR = -4.0 dB，耗时: X.XX 秒
     Welch算法: 估计值=X.XX MHz, 绝对误差=X.XX MHz, 相对误差=X.XX%
     AR模型:   估计值=X.XX MHz, 绝对误差=X.XX MHz, 相对误差=X.XX%
  ...

========================================
Rayleigh信道带宽估计误差总结
========================================
理想带宽: 8.00 MHz
SNR(dB)  | Welch估计(MHz) | Welch绝对误差(MHz) | Welch相对误差(%) | AR估计(MHz) | AR相对误差(%)
...
========================================

仿真完成！
结束时间: 2025-12-10 10:05:00
总仿真时间: XXX.XX 秒 (X.XX 分钟)
========================================
```

### 2. 图形输出

程序会生成以下图形：

1. **估计带宽前的原始基带OFDM信号**
   - 时域波形（实部和虚部）
   - 频域频谱（双边和单边）

2. **输入到带宽估计模型的信号（Rayleigh信道）**
   - 时域波形
   - 频域频谱（标记载波频率和理论带宽）

3. **Rayleigh信道下的带宽检测率对比**
   - AR模型法和Welch算法的性能对比曲线

4. **功率谱密度估计图**（当`k=1`时）
   - AR模型功率谱密度估计
   - Welch算法功率谱密度估计
   - OFDM信号频谱

---

## 带宽检测率计算

`Bandwidth_rate_rayleigh`函数计算不同SNR下的带宽检测率：

```matlab
B_rate = 1 - abs((B_estimated - B_ideal)) / B_ideal
```

其中：
- `B_estimated`：估计的带宽值（Welch或AR方法）
- `B_ideal`：理想带宽值（8 MHz）

检测率越接近1（100%），表示估计越准确。

---

## 使用示例

### 基本使用

```matlab
% 直接运行程序
method
```

### 修改参数

在`method.m`文件中修改以下参数：

```matlab
N = 20;              % OFDM符号数量
fc = 10e6;           % 载波频率（10 MHz）
fs = 40e6;           % 采样频率（40 MHz）
snr = -4:2:20;       % 信噪比范围（-4到20dB，步长2dB）

% Rayleigh信道参数
itau = floor([0,1e-8,2e-8,5e-8,2e-7,5e-7].*fs);  % 多径延时
power = [0,-1.0,-7.0,-10.0,-12.0,-17.0];         % 多径功率（dB）
fmax = 20;                                          % 最大多普勒频率（Hz）
itn = [10000,20000,30000,40000,50000,60000];      % 瑞利信道记录次数
```

### 单独调用函数

```matlab
% 生成OFDM信号
[sig_ofdm] = PSD_generate(20);

% 设置参数
fc = 10e6;      % 载波频率
fs = 40e6;      % 采样频率
snr = 20;       % 信噪比（dB）

% 计算带宽（两种方法）
[B_welch, B_ar] = PSD_OFDM_rayleigh(sig_ofdm, fc, fs, snr, 1, ...
    itau, power, fmax, itn);

% 输出结果
fprintf('Welch算法估计带宽: %.2f MHz\n', B_welch/1e6);
fprintf('AR模型估计带宽: %.2f MHz\n', B_ar/1e6);
```

---

## 默认参数说明

以下是程序中使用的主要默认参数。**详细的参数说明请参考[信号参数](#信号参数)章节**。

### 快速参考

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `N` | 20 | OFDM符号数量 |
| `para` | 128 | 数据子载波数 |
| `M` | 16 | QAM调制阶数（16-QAM） |
| `fc` | 10 MHz | 载波频率 |
| `fs` | 40 MHz | 采样频率 |
| `snr` | -4:2:20 dB | 信噪比范围（13个点） |
| `B_ideal` | 8 MHz | 理想带宽值 |
| `fmax` | 20 Hz | 最大多普勒频率 |
| 多径数 | 6 | 多径衰落路径数 |
| 循环前缀比例 | 1/4 | 循环前缀与有效数据长度比 |
| 过采样倍数 | 4 | IFFT前的过采样倍数 |

---

## 与estimateBandwidthPSD.m的关系

`method.m`中的`PSD_OFDM_rayleigh`函数现在支持调用独立的工具函数`estimateBandwidthPSD.m`：

- **如果存在**`estimateBandwidthPSD.m`：优先使用工具函数进行带宽估计
- **如果不存在**：使用内部实现（向后兼容）

这样可以提高代码的模块化和可重用性。

---

## 参考文献

1. **Welch算法**：
   - Welch, P. D. (1967). "The use of fast Fourier transform for the estimation of power spectra: A method based on time averaging over short, modified periodograms." *IEEE Transactions on Audio and Electroacoustics*, 15(2), 70-73.

2. **AR模型和Burg算法**：
   - Burg, J. P. (1967). "Maximum entropy spectral analysis." *37th Annual International SEG Meeting*, Oklahoma City.
   - Akaike, H. (1974). "A new look at the statistical model identification." *IEEE Transactions on Automatic Control*, 19(6), 716-723.

---

## 注意事项

1. **采样频率一致性**：确保用于功率谱估计的`fs`与信号生成时的采样频率一致。

2. **阈值选择**：
   - Welch算法使用固定-3dB阈值
   - AR模型法根据SNR自适应选择阈值

3. **模型阶数**：AR模型的阶数通过AIC准则自动选择，一般不超过信号长度的1/3。

4. **频率分辨率**：
   - Welch算法：\(\Delta f = \frac{fs}{N_{FFT}}\)
   - AR模型法：\(\Delta f = \frac{fs}{N_{freq}}\)（\(N_{freq} = 200,000\)）

5. **归一化处理**：两种方法都将功率谱归一化到最大值（峰值在0dB），便于比较和阈值检测。

6. **计算时间**：程序运行时间取决于SNR范围、蒙特卡洛仿真次数和信号长度。对于默认参数，预计需要几分钟到十几分钟。

---

## 更新日志

- **2017.03.01**：初始版本，实现Welch算法和AR模型法
- **2025.12.10**：
  - 添加详细注释和文档说明
  - 添加进度输出和错误统计
  - 支持调用`estimateBandwidthPSD.m`工具函数
  - 添加原始信号和输入信号的图形显示
  - 优化代码结构和可读性
