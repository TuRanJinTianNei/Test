# OFDM信号功率谱密度分析技术文档

## 1. 文档概述

### 1.1 文档信息
- **文档名称**: test2.m 技术文档
- **版本**: v1.0
- **创建日期**: 2024
- **作者**: 物联网工程实践实验8
- **文件路径**: `training/test2.m`

### 1.2 文档目的
本文档详细说明了 `test2.m` 脚本的功能、原理、使用方法和技术细节。该脚本主要用于生成OFDM（正交频分复用）信号，并使用Welch周期图法计算其功率谱密度（PSD），通过分段平均方法对功率谱进行平滑处理。

## 2. 功能描述

### 2.1 主要功能
本脚本实现以下核心功能：

1. **OFDM信号生成**
   - 生成随机数据并进行QAM调制
   - 执行IFFT变换将频域信号转换为时域
   - 添加循环前缀（Cyclic Prefix）
   - 串行化生成完整的OFDM信号

2. **功率谱密度计算**
   - 使用Welch周期图法计算PSD（默认参数）
   - 使用自定义参数计算更平滑的PSD

3. **信号平滑处理**
   - 通过分段平均方法对功率谱进行第一次平滑
   - 降低噪声影响，提高功率谱的可读性

4. **结果可视化**
   - 显示OFDM时域信号波形
   - 展示不同方法计算的功率谱密度
   - 对比原始PSD与平滑后的PSD

### 2.2 应用场景
- 通信系统性能分析
- 信号处理算法验证
- 功率谱密度估计研究
- 教学演示和实验

## 3. 系统要求

### 3.1 软件环境
- **MATLAB版本**: R2016b 或更高版本
- **必需工具箱**: 
  - Signal Processing Toolbox（用于 `pwelch` 函数）
  - Communications Toolbox（用于 `qammod` 函数）

### 3.2 硬件要求
- 内存: 建议 4GB 以上
- 处理器: 无特殊要求
- 显示器: 支持图形显示（用于可视化）

## 4. 参数说明

### 4.1 OFDM信号参数

| 参数名称 | 变量名 | 默认值 | 单位 | 说明 |
|---------|--------|--------|------|------|
| 子载波数量 | `N` | 64 | - | OFDM系统的子载波总数 |
| 循环前缀长度 | `N_cp` | 16 | - | 每个OFDM符号的循环前缀采样点数 |
| QAM调制阶数 | `M` | 4 | - | 4-QAM调制（每个符号2比特） |
| OFDM符号数量 | `num_symbols` | 100 | - | 生成的OFDM符号总数 |
| 采样频率 | `fs` | 1e6 | Hz | 信号采样频率（1 MHz） |

### 4.2 噪声参数

| 参数名称 | 变量名 | 默认值 | 单位 | 说明 |
|---------|--------|--------|------|------|
| 信噪比 | `SNR_dB` | 20 | dB | 添加的高斯白噪声信噪比 |

### 4.3 Welch方法参数

| 参数名称 | 变量名 | 默认值 | 说明 |
|---------|--------|--------|------|
| 窗口长度 | `window_length` | 信号长度/8 | Welch方法的窗口长度 |
| 重叠率 | `overlap_ratio` | 0.5 | 窗口重叠比例（50%） |
| FFT点数 | `nfft` | 2^nextpow2(window_length) | FFT变换的点数（2的幂次） |

### 4.4 平滑处理参数

| 参数名称 | 变量名 | 默认值 | 说明 |
|---------|--------|--------|------|
| 分段数量 | `num_segments` | 50 | 将频率轴分成的段数 |

## 5. 算法原理

### 5.1 OFDM信号生成原理

#### 5.1.1 QAM调制
- 生成随机整数数据：`data ∈ [0, M-1]`
- 使用Gray编码的QAM调制：`modulated_data = qammod(data, M, 'gray')`
- 输出复数调制符号

#### 5.1.2 IFFT变换
- 将频域调制符号通过IFFT转换为时域：
  ```
  ofdm_symbols = ifft(modulated_data, N)
  ```
- IFFT点数等于子载波数量 `N`

#### 5.1.3 循环前缀添加
- 将每个OFDM符号的最后 `N_cp` 个采样点复制到符号开头
- 目的：消除符号间干扰（ISI）和载波间干扰（ICI）
- 实现：
  ```
  ofdm_symbols_cp = [ofdm_symbols(end-N_cp+1:end, :); ofdm_symbols]
  ```

#### 5.1.4 信号串行化
- 将二维OFDM符号矩阵重塑为一维时域信号
- 总采样点数：`(N + N_cp) × num_symbols`

### 5.2 Welch周期图法原理

#### 5.2.1 Welch方法的平滑机制

**重要概念**：Welch方法本身已经通过**分段平均**实现了第一次平滑处理！

与传统的周期图法（直接对整个信号做FFT）相比，Welch方法的核心改进就是：
- **传统周期图法**：对整个信号做一次FFT → 结果波动大、方差大
- **Welch方法**：将信号分段，每段做FFT，然后**对所有段的功率谱求平均** → 结果更平滑、方差更小

这就是为什么Welch方法被称为"改进的周期图法"——它通过分段平均实现了平滑。

#### 5.2.2 Welch方法的实现步骤

Welch方法是一种改进的周期图功率谱估计方法，通过以下步骤实现：

1. **分段处理（第一次平滑的关键）**
   - 将信号分成多个重叠的段
   - 每段长度为 `window_length`
   - 相邻段重叠 `noverlap` 个采样点（通常50%重叠）
   - **目的**：通过多段平均来平滑功率谱

2. **加窗处理**
   - 对每段信号应用窗函数（默认Hamming窗）
   - 减少频谱泄漏
   - 让每段的边界更平滑

3. **FFT变换**
   - 对每段加窗后的信号进行FFT
   - FFT点数为 `nfft`
   - 得到每段的频域表示

4. **功率谱计算**
   - 计算每段的功率谱：`|FFT|²`
   - **关键步骤**：对所有段的功率谱求平均 ← 这就是第一次平滑
   - 平均操作降低了方差，使结果更平滑

5. **归一化**
   - 根据窗函数能量和采样频率进行归一化
   - 确保功率谱的单位正确

**数学表达式**：
```
P_welch(f) = (1/K) × Σ |X_k(f)|²
```
其中：
- `K` 是段数（分段越多，平滑效果越好，但计算量越大）
- `X_k(f)` 是第k段信号的FFT
- **平均操作 `(1/K) × Σ`** 就是平滑的核心

#### 5.2.3 Welch方法平滑效果示例

假设信号有8000个采样点，使用Welch方法：

```
原始信号（时域，8000个点）
    ↓ 分段（假设分成8段，每段1000个点）
段1: [采样点1-1000]   → FFT → 功率谱1
段2: [采样点501-1500] → FFT → 功率谱2  (重叠50%)
段3: [采样点1001-2000]→ FFT → 功率谱3
...
段8: [采样点7001-8000]→ FFT → 功率谱8
    ↓ 对所有功率谱求平均
最终PSD = (功率谱1 + 功率谱2 + ... + 功率谱8) ÷ 8
```

**结果**：
- 如果只用一段：方差大，波动剧烈
- 用8段平均：方差降低到原来的1/8，更平滑

#### 5.2.4 为什么Welch方法需要平滑？

功率谱估计的本质问题：
- **估计方差**：单次FFT的功率谱估计方差很大
- **解决方案**：通过多次独立估计的平均来降低方差
- **Welch方法**：将信号分段，每段独立估计，然后平均

**平滑效果**：
- 段数越多 → 平均效果越好 → 方差越小 → 越平滑
- 但段数太多 → 每段太短 → 频率分辨率下降

需要在**平滑度**和**频率分辨率**之间权衡。

### 5.3 分段平均平滑原理

#### 5.3.1 基本概念

**重要理解**：分段平均平滑是在Welch方法基础上的**第二次平滑处理**。

**两次平滑的区别**：

| 平滑方式 | 处理对象 | 平滑方法 | 目的 |
|---------|---------|---------|------|
| **第一次平滑（Welch方法）** | 原始时域信号 | 将信号分段，每段FFT后求平均 | 降低功率谱估计的方差，减少随机波动 |
| **第二次平滑（分段平均）** | Welch方法得到的PSD | 将PSD频率轴分段，每段求平均 | 进一步降低噪声，减少数据量，提高可读性 |

**形象比喻**：
- **Welch方法（第一次平滑）**：把粗糙的石头表面打磨一遍，去掉大的起伏
- **分段平均（第二次平滑）**：再打磨一遍，让表面更加光滑

**为什么需要第二次平滑？**

虽然Welch方法已经平滑了，但：
1. **仍有局部波动**：Welch结果可能仍有小的起伏和噪声
2. **数据量太大**：Welch可能产生几千个频率点，不便于分析
3. **需要更平滑的趋势**：某些应用需要更平滑的曲线来观察整体特征
4. **便于比较**：将不同信号统一到相同数量的点，便于对比

**总结**：
- **Welch方法**：已经对信号进行了第一次平滑（通过时域分段和频域平均）
- **分段平均平滑**：对Welch的结果再进行一次"粗化"处理，让曲线更平滑，数据更精简

#### 5.3.2 工作原理（通俗解释）

**比喻**：想象你有一条起伏不平的山路（Welch方法得到的PSD曲线），分段平均就像把这条路分成很多小段，每段取一个平均高度，然后用这些平均高度连成一条新的、更平滑的路。

**具体步骤**：

1. **第一步：将频率轴分段**
   ```
   假设Welch方法得到了4097个频率点的PSD值
   我们要分成50段
   每段长度 = 4097 ÷ 50 ≈ 81个点
   ```

2. **第二步：计算每段的平均值**
   ```
   第1段：包含第1-81个PSD值 → 求平均 → 得到1个平滑后的值
   第2段：包含第82-162个PSD值 → 求平均 → 得到1个平滑后的值
   第3段：包含第163-243个PSD值 → 求平均 → 得到1个平滑后的值
   ...
   第50段：包含最后81个PSD值 → 求平均 → 得到1个平滑后的值
   ```

3. **第三步：用平均值代表整段**
   - 原来4097个点 → 现在50个点
   - 每个点代表一段的平均功率

#### 5.3.3 图示说明

**原始Welch PSD（4097个点）**：
```
频率:  f1    f2    f3    f4    f5    ...  f4097
PSD:   P1    P2    P3    P4    P5    ...  P4097
       ↑波动较大，有很多小起伏↑
```

**分段平均后（50个点）**：
```
段1:  [P1, P2, ..., P81]   → 平均值 = P_smooth(1)
段2:  [P82, P83, ..., P162] → 平均值 = P_smooth(2)
段3:  [P163, ..., P243]     → 平均值 = P_smooth(3)
...
段50: [P4017, ..., P4097]  → 平均值 = P_smooth(50)
       ↑平滑后，波动减小↑
```

#### 5.3.4 代码实现详解

让我们逐行分析代码：

```matlab
num_segments = 50;  % 要分成50段
segment_length = floor(length(psd_smooth) / num_segments);  
% 计算每段的长度，例如：4097 ÷ 50 ≈ 81

psd_smoothed = zeros(num_segments, 1);  % 预分配空间，存放50个结果
freq_smoothed = zeros(num_segments, 1); % 预分配空间，存放50个频率值

for i = 1:num_segments  % 对每一段进行处理
    % 计算这一段的起始和结束索引
    start_idx = (i-1) * segment_length + 1;  
    % 例如：第1段从1开始，第2段从82开始，第3段从163开始...
    
    end_idx = min(i * segment_length, length(psd_smooth));
    % 例如：第1段到81结束，第2段到162结束...
    % 注意：最后一段可能不足segment_length，所以用min保证不越界
    
    % 对这一段内的所有PSD值求平均
    psd_smoothed(i) = mean(psd_smooth(start_idx:end_idx));
    
    % 对这一段内的所有频率值求平均（作为代表频率）
    freq_smoothed(i) = mean(freq_smooth(start_idx:end_idx));
end
```

#### 5.3.5 具体数值例子

假设：
- Welch方法得到 `psd_smooth` 有1000个点
- 分成10段（`num_segments = 10`）
- 每段100个点（`segment_length = 100`）

**处理过程**：

| 段号 | 索引范围 | PSD值示例 | 平均值计算 |
|------|---------|-----------|-----------|
| 1 | 1-100 | [0.1, 0.12, 0.09, ..., 0.11] | (0.1+0.12+...+0.11)/100 = 0.105 |
| 2 | 101-200 | [0.15, 0.13, 0.14, ..., 0.16] | (0.15+0.13+...+0.16)/100 = 0.145 |
| 3 | 201-300 | [0.08, 0.10, 0.09, ..., 0.08] | (0.08+0.10+...+0.08)/100 = 0.090 |
| ... | ... | ... | ... |
| 10 | 901-1000 | [0.12, 0.11, 0.13, ..., 0.12] | (0.12+0.11+...+0.12)/100 = 0.120 |

**结果**：
- 原来：1000个PSD值（波动大）
- 现在：10个PSD值（平滑）

#### 5.3.6 为什么这样做？

1. **降低噪声影响**
   - 每段内的随机波动会被平均掉
   - 保留的是整体趋势

2. **减少数据量**
   - 从几千个点减少到几十个点
   - 便于后续分析和存储

3. **提高可读性**
   - 平滑后的曲线更容易看出主要特征
   - 减少视觉上的干扰

4. **便于比较**
   - 不同信号的PSD可以用相同数量的点表示
   - 便于进行统计分析

#### 5.3.7 数学表达式

**分段平均公式**：
```
P_smooth(i) = (1/L_i) × Σ P_welch(f_j)
```

其中：
- `i` 是段号（1到num_segments）
- `L_i` 是第i段包含的频率点数（通常是segment_length）
- `P_welch(f_j)` 是Welch方法在第j个频率点计算的PSD值
- `f_j` 属于第i段的频率范围：`[(i-1)×segment_length+1, i×segment_length]`

**频率对应公式**：
```
f_smooth(i) = (1/L_i) × Σ f_j
```

每段的代表频率是该段内所有频率的平均值。

#### 5.3.8 参数选择的影响

| 分段数量 | 效果 | 适用场景 |
|---------|------|---------|
| **少（10-20段）** | 非常平滑，但可能丢失细节 | 快速查看整体趋势 |
| **中（30-50段）** | 平衡平滑度和细节保留 | **推荐使用** |
| **多（100+段）** | 保留更多细节，但平滑效果差 | 需要精细分析 |

**建议**：根据Welch PSD的点数来选择分段数量，通常取 `Welch点数 ÷ 50` 到 `Welch点数 ÷ 100` 之间。

## 6. 代码结构

### 6.1 代码模块划分

```
test2.m
├── 初始化模块
│   ├── clear all
│   ├── close all
│   └── clc
│
├── 参数设置模块
│   ├── OFDM参数
│   ├── 噪声参数
│   └── 处理参数
│
├── OFDM信号生成模块
│   ├── 数据生成与QAM调制
│   ├── IFFT变换
│   ├── 循环前缀添加
│   ├── 信号串行化
│   └── 噪声添加
│
├── 功率谱密度计算模块
│   ├── Welch方法（默认参数）
│   └── Welch方法（自定义参数）
│
├── 分段平均平滑模块
│   ├── 频率分段
│   └── 段内平均
│
├── 可视化模块
│   ├── 时域信号显示
│   ├── PSD对比显示
│   └── 统计信息输出
│
└── 结果输出模块
    └── 控制台统计信息
```

### 6.2 关键函数说明

#### 6.2.1 MATLAB内置函数

| 函数名 | 功能 | 所属工具箱 |
|--------|------|-----------|
| `qammod` | QAM调制 | Communications Toolbox |
| `ifft` | 逆快速傅里叶变换 | MATLAB核心 |
| `pwelch` | Welch周期图功率谱估计 | Signal Processing Toolbox |
| `awgn` | 添加高斯白噪声 | Communications Toolbox |
| `semilogy` | 半对数坐标绘图 | MATLAB核心 |

#### 6.2.2 自定义算法

- **分段平均平滑算法**（第53-69行）
  - 输入：Welch方法计算的PSD和频率
  - 输出：平滑后的PSD和对应频率
  - 算法：循环分段并计算平均值

## 7. 使用方法

### 7.1 基本使用

1. **打开MATLAB**
   ```matlab
   cd('training')  % 切换到脚本所在目录
   ```

2. **运行脚本**
   ```matlab
   test2
   ```
   或
   ```matlab
   run('test2.m')
   ```

3. **查看结果**
   - 自动弹出两个图形窗口
   - 控制台输出统计信息

### 7.2 参数修改

根据需求修改脚本中的参数：

```matlab
%% 修改OFDM参数
N = 128;              % 增加子载波数量
N_cp = 32;            % 增加循环前缀长度
M = 16;               % 使用16-QAM调制
num_symbols = 200;    % 增加符号数量

%% 修改噪声参数
SNR_dB = 30;          % 提高信噪比

%% 修改平滑参数
num_segments = 100;   % 增加分段数量（更平滑）
```

### 7.3 结果保存

在脚本末尾添加保存代码：

```matlab
%% 保存结果
save('ofdm_results.mat', 'ofdm_signal_noisy', 'psd_smooth', 'freq_smooth', ...
     'psd_smoothed', 'freq_smoothed');

%% 保存图形
saveas(figure(1), 'ofdm_analysis.png');
saveas(figure(2), 'psd_comparison.png');
```

## 8. 输出说明

### 8.1 图形输出

#### 图1：OFDM信号分析（2×2子图）
- **子图1**: OFDM时域信号（实部，前1000个采样点）
  - X轴：时间（毫秒）
  - Y轴：幅度
- **子图2**: Welch周期图法 - 默认参数
  - X轴：频率（MHz）
  - Y轴：功率谱密度（dB/Hz，对数坐标）
- **子图3**: Welch周期图法 - 自定义参数（平滑）
  - X轴：频率（MHz）
  - Y轴：功率谱密度（dB/Hz，对数坐标）
- **子图4**: 分段平均平滑后的PSD
  - X轴：频率（MHz）
  - Y轴：功率谱密度（dB/Hz，对数坐标）

#### 图2：功率谱密度对比
- 蓝色实线：Welch PSD（原始）
- 红色实线：分段平均平滑后
- 用于直观对比平滑效果

### 8.2 控制台输出

脚本运行后，控制台会输出以下统计信息：

```
=== OFDM信号功率谱密度分析结果 ===
信号长度: 8000 个采样点
采样频率: 1.00 MHz
Welch PSD点数: 4097
分段平均后点数: 50
平均功率: -XX.XX dB
峰值功率: -XX.XX dB
===================================
```

### 8.3 变量输出

脚本运行后，工作空间中包含以下主要变量：

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `ofdm_signal` | double数组 | 无噪声OFDM信号 |
| `ofdm_signal_noisy` | double数组 | 含噪声OFDM信号 |
| `psd_default` | double数组 | Welch默认参数PSD |
| `freq_default` | double数组 | 默认参数对应频率 |
| `psd_smooth` | double数组 | Welch自定义参数PSD |
| `freq_smooth` | double数组 | 自定义参数对应频率 |
| `psd_smoothed` | double数组 | 分段平均平滑后PSD |
| `freq_smoothed` | double数组 | 平滑后对应频率 |

## 9. 性能分析

### 9.1 计算复杂度

- **OFDM信号生成**: O(N × num_symbols × log(N))
  - IFFT复杂度：O(N log N)
  - 符号数量：num_symbols
  
- **Welch方法**: O(K × nfft × log(nfft))
  - K为段数，约等于 `(信号长度 - noverlap) / (window_length - noverlap)`
  
- **分段平均**: O(L)
  - L为PSD数组长度

### 9.2 内存占用

- **信号存储**: `(N + N_cp) × num_symbols × 8` 字节（双精度）
- **PSD存储**: `nfft × 8` 字节
- **总内存**: 约几MB到几十MB（取决于参数设置）

### 9.3 运行时间

在标准PC上（Intel i5, 8GB RAM）：
- 信号生成：< 0.1秒
- Welch计算：< 0.5秒
- 分段平均：< 0.01秒
- **总运行时间**: < 1秒

## 10. 注意事项

### 10.1 参数选择建议

1. **子载波数量 `N`**
   - 建议选择2的幂次（64, 128, 256等）
   - 便于FFT/IFFT计算

2. **循环前缀长度 `N_cp`**
   - 通常为 `N/4` 或 `N/8`
   - 必须大于信道最大时延扩展

3. **窗口长度 `window_length`**
   - 建议为信号长度的1/4到1/8
   - 太短：频率分辨率低
   - 太长：平滑效果差

4. **分段数量 `num_segments`**
   - 建议在20-100之间
   - 太少：平滑不足
   - 太多：信息损失

### 10.2 常见问题

#### 问题1：图形不显示
**原因**: MATLAB图形窗口被关闭或禁用
**解决**: 检查 `close all` 是否在脚本开头，确保图形功能正常

#### 问题2：函数未定义错误
**原因**: 缺少必要的工具箱
**解决**: 安装 Signal Processing Toolbox 和 Communications Toolbox

#### 问题3：内存不足
**原因**: 参数设置过大
**解决**: 减小 `num_symbols` 或 `N` 的值

#### 问题4：PSD结果异常
**原因**: 采样频率设置不当
**解决**: 确保 `fs` 大于信号带宽的2倍（满足奈奎斯特定理）

## 11. 扩展功能建议

### 11.1 功能扩展

1. **多径信道模拟**
   ```matlab
   % 添加多径衰落信道
   channel = [1, 0.5, 0.3];  % 多径系数
   ofdm_signal_channel = filter(channel, 1, ofdm_signal);
   ```

2. **不同调制方式支持**
   ```matlab
   % 支持BPSK, QPSK, 16-QAM, 64-QAM等
   M = 16;  % 16-QAM
   ```

3. **自适应分段数量**
   ```matlab
   % 根据PSD变化率自动调整分段数量
   num_segments = adaptive_segmentation(psd_smooth);
   ```

4. **功率谱密度导出**
   ```matlab
   % 导出为CSV格式
   writematrix([freq_smoothed, psd_smoothed], 'psd_results.csv');
   ```

### 11.2 性能优化

1. **并行计算**
   - 使用 `parfor` 加速分段平均计算

2. **内存优化**
   - 使用单精度浮点数（`single`）减少内存占用

3. **GPU加速**
   - 使用GPU进行IFFT和FFT计算

## 12. 参考文献

1. Welch, P. D. (1967). "The use of fast Fourier transform for the estimation of power spectra: A method based on time averaging over short, modified periodograms." *IEEE Transactions on Audio and Electroacoustics*, 15(2), 70-73.

2. Proakis, J. G., & Salehi, M. (2008). *Digital Communications* (5th ed.). McGraw-Hill Education.

3. Oppenheim, A. V., & Schafer, R. W. (2010). *Discrete-Time Signal Processing* (3rd ed.). Prentice Hall.

4. MATLAB Documentation. Signal Processing Toolbox - pwelch. MathWorks.

5. MATLAB Documentation. Communications Toolbox - qammod. MathWorks.

## 13. 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2024 | 初始版本，实现OFDM信号生成和Welch PSD计算 | - |

## 14. 附录

### 14.1 符号说明

- **OFDM**: Orthogonal Frequency Division Multiplexing（正交频分复用）
- **PSD**: Power Spectral Density（功率谱密度）
- **QAM**: Quadrature Amplitude Modulation（正交幅度调制）
- **IFFT**: Inverse Fast Fourier Transform（逆快速傅里叶变换）
- **FFT**: Fast Fourier Transform（快速傅里叶变换）
- **SNR**: Signal-to-Noise Ratio（信噪比）
- **ISI**: Inter-Symbol Interference（符号间干扰）
- **ICI**: Inter-Carrier Interference（载波间干扰）

### 14.2 相关文件

- `test.m`: 其他测试脚本
- `test2.m`: 本脚本文件

---

**文档结束**

