### test2.m 使用说明（README）

`test2.m` 是一个基于 LTE 思路实现的 OFDM 发射-信道-接收端完整仿真脚本，包含：
- 16QAM 比特映射与子载波映射（采用频域共轭对称，保证 IFFT 输出为实信号）
- IFFT 生成时域符号、添加循环前缀（固定 CP 长度）与升余弦加窗
- 帧/串行信号构造（在 CP 范围内进行重叠相加，降低旁瓣）
- Jakes 瑞利衰落信道 + AWGN 信道
- 导频辅助信道估计与均衡（可选）
- **循环前缀相关性检测算法**：实现对信号频率和带宽的检测
  - 符号起始位置检测
  - 载波频率偏移（CFO）估计
  - 信号带宽检测（3dB带宽、有效带宽、90%功率带宽）
  - 符号周期自动检测
- 接收端去 CP → FFT → 信道估计与均衡 → 解调判决、误码率计算
- 多幅图形用于观测频域/时域/频谱、星座图、发收比特、CP 相关性检测结果等

---

### 环境要求
- MATLAB R2016a 或更高版本（建议更高版本）
- 同目录下依赖函数：
  - `qam16.m`（16QAM 映射）
  - `demoduqam16.m`（16QAM 判决解调）
  - `rcoswindow.m`（升余弦窗）
  - `jakesChannel.m`（Jakes 瑞利衰落信道，如果使用瑞利衰落）
  - `pilot_equalization.m`（导频辅助信道估计与均衡，如果使用导频均衡）

---

### 运行方法
1. 打开 MATLAB，将当前工作目录切换到本脚本所在路径。
2. 直接运行：
   ```matlab
   test2
   ```

---

### 关键可调参数（在脚本顶部附近）
- **基本频率参数**：
  - `subcarrier_spacing = 15e3`：子载波间隔（15 kHz）
  - `fs = 15.36e6`：采样频率（15.36 MHz）
- **IFFT/FFT 参数**：
  - `IFFT_bin_length = 1024`：IFFT 点数
- **子载波配置**：
  - `carrier_count = 300`：有效数据子载波数（正频率数据，负频率为镜像）
  - 占用子载波总数：2×300 + 1(DC) = 601 个
  - 空子载波数：1024 - 601 = 423 个（保护带）
- **CP 配置**：
  - `GI = 72`：循环前缀长度（固定 CP，样本数）
  - `PrefixRatio = 72/1024`：循环前缀比例
- **加窗配置**：
  - `beta = 1/16`：加窗滚降系数
  - `GIP`：后缀长度（自动计算，不超过 CP 长度）
- **符号数与比特数**：
  - `total_symbols = 100`：总符号数
  - `symbols_per_frame = 50`：每帧符号数
  - `bits_per_symbol = 4`：每个子载波承载的比特数（16QAM）
- **信道参数**：
  - `targetSNRdB = 15`：目标信噪比（dB），用于详细分析
  - `use_rayleigh_fading = true`：是否使用瑞利衰落信道
  - `fd = 100`：最大多普勒频移（Hz）
- **导频均衡参数**：
  - `use_pilot_equalization = true`：是否使用导频均衡
  - `pilot_spacing = 6`：导频间隔（每隔 6 个子载波插入一个导频）
  - `interpolation_method = 'linear'`：插值方法（'linear' 或 'spline'）

提示：以上参数均可直接在脚本中修改后再次运行生效。

---

### 随机性与复现
- 本脚本每次运行都会随机生成新的发射比特与噪声：
  ```matlab
  rng('shuffle');  % 基于当前时间设置随机种子，确保每次运行都不同
  baseband_out = randi([0 1], 1, baseband_out_length);
  ```
- 如需复现实验（固定随机序列），可将上述行替换为固定种子，例如：
  ```matlab
  rng(20251116,'twister');  % 任意固定整数种子
  baseband_out = randi([0 1], 1, baseband_out_length);
  ```
- 注意：每次 BER-SNR 曲线计算循环中，都会生成新的随机噪声，确保每个 SNR 点的噪声样本都是独立的。

---

### 帧结构与 CP 设计
- **CP 作用**：循环前缀等效于在符号前复制尾部一段，用于对抗多径时延扩展并保持子载波正交，避免符号间干扰（ISI）和子载波间干扰（ICI）。
- **固定 CP 长度**：本脚本采用固定 CP 长度 `GI = 72`，适用于所有符号。
- **符号结构**：每个 OFDM 符号的结构为 `[CP(GI) | 主体(N) | 后缀(GIP)]`
  - CP 长度：`GI = 72` 个样本
  - 主体长度：`N = 1024` 个样本（IFFT 点数）
  - 后缀长度：`GIP` 个样本（用于加窗过渡，不超过 CP 长度）
- **加窗与重叠**：脚本在 CP 范围内进行升余弦窗的平滑过渡与"重叠相加"：
  - 使用升余弦窗（滚降系数 `beta = 1/16`）平滑符号边缘
  - 重叠相加：当前符号的后缀与下一个符号的 CP 前 GIP 个样本重叠相加
  - 保证过渡仅发生在 CP 内，不影响有效符号主体数据
  - LTE 风格：重叠区域限制在 CP 内，接收端去除 CP 时不受影响

---

### 时间结构层次：帧 - 子帧 - 时隙 - 符号 的关系
本脚本参考 LTE 正常 CP（Normal CP）的时间组织方式。四级结构与典型时长如下：

- 帧（Frame）
  - 无线帧时长为 10 ms。
  - 每帧包含 10 个子帧。
- 子帧（Subframe）
  - 子帧时长为 1 ms。
  - 每子帧包含 2 个时隙。
- 时隙（Slot）
  - 时隙时长为 0.5 ms。
  - 正常 CP 时，每个时隙包含 7 个 OFDM 符号；扩展 CP 时为 6 个。
  - 正常 CP 情况下，每个时隙的第 1 个符号使用较长 CP，其余符号使用较短 CP。
- 符号（OFDM Symbol）
  - 一个 OFDM 符号由“循环前缀（CP）+ 有效符号体（N 个采样）(+ 可选后缀/用于加窗过渡)”构成。
  - 正常 CP：在 30.72 MHz 采样率（10 MHz 系统）下，典型长 CP 约 160 点，短 CP 约 144 点；有效符号体为 IFFT 点数（本脚本为 2048）。

用包含关系表示：
- 1 帧 = 10 子帧 = 20 时隙
- 1 子帧 = 2 时隙
- 1 时隙（正常 CP）= 7 符号（第 1 个符号长 CP，其余短 CP）

与脚本配置的对应关系（快速仿真）
- 为了演示链路关键环节，脚本未逐层构造"10 ms 帧 → 1 ms 子帧 → 0.5 ms 时隙"的完整层级，而是采用 `total_symbols = 100` 的连续符号序列。
- 本脚本使用固定 CP 长度（`GI = 72`），简化了 LTE 的长/短 CP 设计，专注于演示 OFDM 系统的核心功能。
- 符号组织：`symbols_per_frame = 50`，每帧包含 50 个符号，总共 `total_symbols = 100` 个符号（2 帧）。
- 若需要严格的帧/子帧/时隙层级组织或长/短 CP 设计，可修改脚本中的 CP 分配逻辑；当前脚本为了演示频谱/时域/星座、BER 评估和 CP 相关性检测而进行了简化。

---

### 参数详解（test2.m 中的重要变量）
以下参数在脚本前半部分定义，决定系统配置、映射方式与可视化窗口。实际数值可在脚本中直接修改。

- 基本时间/频率与调制
  - `subcarrier_spacing = 15e3`：子载波间隔（Hz）。LTE 基本间隔为 15 kHz。
  - `fs = 15.36e6`：采样率（Hz）。对应 15.36 MHz 采样频率。
  - `symbol_duration = 1/subcarrier_spacing`：有效符号时长，约 66.67 μs。
  - `bits_per_symbol = 4`：16QAM，每子载波承载 4 比特。

- 频域尺寸与子载波索引
  - `IFFT_bin_length = 1024`：IFFT 点数（N）。决定时域符号有效采样数。
  - 为构造"实信号"时域输出，本脚本使用共轭对称：
    - 正频率数据子载波：`carrier_count = 300`（300 个）
    - 负频率镜像载波：300 个（共轭部分，自动生成）
  - 子载波索引计算：
    - `carriers = (1:carrier_count) + (floor(IFFT_bin_length/4) - floor(carrier_count/2))`
    - `conjugate_carriers = IFFT_bin_length - carriers + 2`
  - 有效子载波计数：
    - `carrier_count = 300`（用于承载数据的正频率数量）
    - 含镜像的总有效子载波数为 2×300 + 1(DC) = 601 个
  - 空子载波（说明）：1024 - 601 = 423 个（保护带）

---

### 子载波分配详解：负频率子载波与空子载波的实际意义

#### 1. 负频率子载波：数学表示，物理上不存在

**数学上的存在：**
- FFT/IFFT 的数学定义包含正负频率分量
- 对于实信号，负频率是正频率的共轭镜像（这是数学性质）

**物理上的不存在：**
- 物理世界中只有正频率
- 负频率是数学表示，不传输独立数据

**在代码中的体现：**
```matlab
IFFT_modulation(:, data_carriers) = data_matrix;              % 正频率：存储实际数据
IFFT_modulation(:, data_conjugate_carriers) = conj(data_matrix);  % 负频率：自动设置为共轭
```

**为什么需要负频率？**
- **生成实信号**：IFFT 输入满足共轭对称时，输出为实信号
- **节省资源**：只需传输正频率数据，负频率自动生成
- **数学一致性**：保证 FFT/IFFT 的数学性质

#### 2. 空子载波（保护带）：物理存在，但不传输数据

**物理上的存在：**
- 这些频率位置在频谱中真实存在
- 它们被设置为 0（不传输数据）

**在代码中的体现：**
```matlab
IFFT_modulation = zeros(symbols_per_carrier, IFFT_bin_length);  % 初始化全零
% 然后只填充有效子载波位置，其余保持为0
```

**空子载波的作用：**

1. **频谱保护带**
   - 减少带外干扰
   - 满足频谱掩码要求
   - 避免与相邻频段干扰

2. **滤波器过渡带**
   - 为模拟/数字滤波器提供过渡空间
   - 减少滤波器设计难度

3. **频率选择性保护**
   - 在频率选择性信道中提供保护
   - 减少边缘子载波的性能下降

4. **系统灵活性**
   - 预留扩展空间
   - 支持不同带宽配置

#### 3. 实际频谱结构示意

```
频率范围: -fs/2 到 +fs/2 (15.36 MHz)

负频率区域（共轭镜像，不独立传输）:
  [空子载波] [共轭镜像数据] [DC附近]

正频率区域（实际传输）:
  [DC] [数据子载波1-300] [空子载波保护带]

实际信号带宽: 300 × 15 kHz = 4.5 MHz
总IFFT带宽: 1024 × 15 kHz = 15.36 MHz
保护带: (1024 - 601) × 15 kHz = 6.345 MHz
```

#### 4. 总结对比

| 类型 | 物理存在 | 传输数据 | 实际意义 |
|------|---------|---------|---------|
| **正频率数据子载波** | ✓ 存在 | ✓ 是 | 实际传输数据的频率 |
| **负频率子载波** | ✗ 不存在 | ✗ 否 | 数学共轭镜像，保证实信号 |
| **空子载波（保护带）** | ✓ 存在 | ✗ 否 | 频谱保护，减少干扰 |

#### 5. 为什么理论信号带宽是 300×15 kHz 而不是 1024×15 kHz？

**IFFT 点数 vs 有效子载波数：**
- **IFFT 点数 = 1024**：FFT/IFFT 变换的总点数，决定频域分辨率
- **有效数据子载波数 = 300**：实际用于传输数据的子载波数（仅正频率）

**子载波分配结构：**
在 1024 个 IFFT bin 中：
- 正频率数据子载波：300 个
- 负频率数据子载波：300 个（共轭镜像，不独立传输数据）
- DC 子载波：1 个（通常不用）
- 空子载波（保护带）：423 个（1024 - 2×300 - 1 = 423）

**带宽计算：**
- **采样频率**：fs = 15.36 MHz = 1024 × 15 kHz（整个 IFFT 的带宽范围）
- **理论信号带宽**：300 × 15 kHz = 4.5 MHz（只计算有效数据子载波占用的带宽）

**为什么不是 1024×15 kHz？**
1. 负频率是共轭镜像，不独立传输数据
2. 保护带（423 个空子载波）用于减少带外干扰、满足频谱掩码要求
3. DC 子载波通常不使用（可能受直流偏置影响）

**关系总结：**
```
采样频率 fs = IFFT点数 × 子载波间隔 = 1024 × 15 kHz = 15.36 MHz
理论信号带宽 = 有效子载波数 × 子载波间隔 = 300 × 15 kHz = 4.5 MHz
占用子载波总数 = 2×300 + 1(DC) = 601 个
空子载波数 = 1024 - 601 = 423 个（保护带）
```

**实际意义总结：**
- **负频率子载波**：数学工具，用于生成实信号，不传输独立数据
- **空子载波**：物理存在，提供保护带，减少干扰，满足频谱规范

因此，虽然负频率在物理上不存在，但它们是数学表示的必要部分；空子载波虽然不传输数据，但在频谱管理和系统设计中非常重要。

---

- 帧/时隙/符号与快速仿真规模
  - `symbols_per_frame = 50`：每帧包含的 OFDM 符号数。
  - `total_symbols = 100`：总符号数（2 帧）。
  - 采用连续符号序列，不严格展开完整帧-子帧-时隙层次，专注于演示 OFDM 系统的核心功能。

- 循环前缀（CP）与符号采样数
  - `GI = 72`：循环前缀长度（固定 CP，样本数）。
  - `PrefixRatio = 72/1024`：循环前缀比例。
  - 单符号总采样点（含后缀）：
    - 符号结构：`[CP(GI) | 主体(N) | 后缀(GIP)]`
    - 符号总长度：`IFFT_bin_length + GI + GIP = 1024 + 72 + GIP`
  - `GIP`：后缀长度（自动计算，`GIP = min(beta*(N+GI), GI)`，不超过 CP 长度）

- 加窗（升余弦窗）与过渡长度
  - `beta = 1/16`：加窗滚降系数（过渡带占比）。
  - `GIP`：后缀长度，配合窗的尾部过渡，限制在 CP 范围内。
  - 窗函数生成：`rcos_win_full = rcoswindow(beta, N+GI)`，仅取前 `N+GI` 点用于 `CP+主体`。
  - LTE 风格重叠相加：符号拼接时在 CP 范围内重叠相加，保证过渡仅发生在 CP 内。

- 比特/符号流水与矩阵维度
  - 每符号比特数（考虑导频）：如果使用导频，实际数据子载波数会减少
    - 不使用导频：`bits_per_symbol_total = carrier_count * bits_per_symbol = 300 * 4 = 1200`
    - 使用导频：`data_carrier_count_actual = carrier_count - pilot_count`（导频间隔为6时，约250个数据子载波）
  - 总比特：`total_bits = total_symbols * bits_per_symbol_total`
  - 发送随机比特：
    ```matlab
    rng('shuffle');  % 基于当前时间设置随机种子
    baseband_out = randi([0 1], 1, baseband_out_length);
    ```
  - 16QAM 映射与重塑：
    - `complex_carrier_matrix = qam16(baseband_out);`
    - `complex_carrier_matrix = reshape(..., data_carrier_count_actual, total_symbols)'` → 行为符号、列为载波

- 频域映射与实信号约束
  - 正频率：将 `complex_carrier_matrix(sym_idx, 1:carrier_count)` 放置到 `carriers_positive`。
  - 负频率：放置正频率的“反序共轭”到 `carriers_negative`，保证 IFFT 输出近似实值（数值误差下再取实部）。
  - DC（bin=1）设为 0。

- IFFT 与串行信号构造
  - `signal_after_IFFT = ifft(IFFT_modulation, IFFT_bin_length, 2);`
  - 对每符号构造结构 `[CP | 主体(N) | 后缀(window_trans)]`，后缀取自符号前部样本，用于与下一个符号 CP 的重叠。
  - 串行拼接时，“重叠相加”长度 `overlap_len = min(prev_window_trans, window_trans, CP_len)`，并仅限制在 CP 内。
  - 对比序列：`Tx_data_withoutwindow` 为未加窗、逐符号直接串接；`Tx_data` 为加窗+重叠相加的 LTE 风格串行。

- 可视化窗口与频谱
  - `zoom_len = 5000`：局部时域窗口长度（Figure 7/8/12/13 使用同一范围，便于对比）。
  - 使用 `fftshift(fft(...))` 生成双边谱，并归一化到自身最大值后转 dB。
  - 归一化频率轴：`(-N/2:(N/2-1))/N`，对应物理频率的 `±fs/2`。

- 信道与噪声参数
  - `use_rayleigh_fading = true`：是否使用瑞利衰落信道（true=使用，false=仅AWGN）。
  - `fd = 100`：最大多普勒频移（Hz），典型值：100Hz（对应约30km/h@2.4GHz）。
  - `N0 = 34`：Jakes 模型散射体数量（基础振荡器数量），典型值：34。
  - `targetSNRdB = 15`：目标信噪比（dB），用于详细分析。
  - 信道传输流程：
    1. 如果使用瑞利衰落：通过 `jakesChannel()` 函数创建瑞利衰落信道，应用多径衰落
    2. 添加 AWGN 噪声：根据目标 SNR 计算噪声方差，添加高斯白噪声
  - 噪声方差：`noise_sigma = Tx_signal_power / 10^(SNR/10)`；标准差 `sqrt(noise_sigma)`。
  - 接收信号：`Rx_data = Rx_faded + noise`（如果使用衰落）或 `Rx_data = Tx_data + noise`（仅AWGN）。
  - 局部窗口 SNR/MSE 打印：基于窗口内 `tx_seg` 与 `rx_seg` 的功率与误差。

- 接收端 FFT 与解调
  - 去除 CP/后缀，仅保留主体 `N` 点：构建 `Rx_data_matrix`，逐符号取 `GI+1 : GI+N`。
  - FFT 解调：`Y1 = fft(Rx_data_complex_matrix, IFFT_bin_length, 2)`
  - 信道估计与均衡（如果使用导频）：
    - 调用 `pilot_equalization` 函数进行信道估计和均衡
    - 使用导频位置的信道响应进行插值估计
    - 零迫均衡（Zero-Forcing Equalization）
  - 提取数据子载波，由极坐标转直角坐标得到 `Rx_complex_carrier_matrix`。
  - 判决：`demoduqam16`，并与 `baseband_out` 比较得到 BER。

- CP 相关性检测算法（频率和带宽检测）
  - 符号起始位置检测：通过滑动窗口计算 CP 与符号尾部的相关性
  - CFO 估计：通过相位差估计载波频率偏移（归一化 CFO 和绝对 CFO）
  - 带宽检测：通过频谱分析检测 3dB 带宽、有效带宽、90% 功率带宽
  - 符号周期检测：自动检测符号周期
  - 多符号平均：使用多个符号的平均提高检测鲁棒性
  - 奈奎斯特定理验证：检查采样频率是否满足奈奎斯特定理要求

- 图形与指标输出
  - Figures 1–16：详见"输出图形（主要）"一节。
  - 命令行打印包括：
    - **仿真摘要**：`total_symbols/total_bits/BER/Tx power/Noise variance/N/Active carriers/Occupied carriers/Guard carriers/CP length/Suffix length/Window roll-off/Solution method` 等
    - **CP 相关性检测结果**：
      - 检测到的符号起始位置、最大相关性、检测到的峰值数量
      - 理论符号周期、检测到的符号周期
      - 频率估计：归一化 CFO、CFO 估计值、载波频率偏移、估计的信号频率、信号中心频率
      - 带宽估计：估计的信号带宽（含检测方法）、3dB 带宽、有效带宽、90% 功率带宽、理论带宽
      - 系统参数：采样频率、子载波间隔、信号带宽、采样频率/信号带宽比值、奈奎斯特定理验证、IFFT 点数、CP 长度
    - **BER-SNR 曲线**：在 10-30 dB 范围内，步进 2 dB，计算各 SNR 点的误码率

---

### 输出图形（主要）
- Figure 1：IFFT 输入各频点幅度（展示子载波分配与空子载波）
- Figure 2：IFFT 输入相位（验证共轭对称）
- Figure 3：单符号时域（未加 CP/后缀）
- Figure 4：单符号时域（加 CP 与后缀）
- Figure 5：单符号时域（加窗后）
- Figure 6：发送端串行信号对比（未加窗逐符号串接 vs. LTE 风格重叠相加）
- Figure 7：局部窗口时域对比（未加窗 vs. 加窗）
- Figure 8：局部窗口频域对比（未加窗 vs. 加窗，双边谱）
- Figure 9：接收端 16QAM 星座图（均衡前）
- Figure 10：发/收比特流前 100 位对比
- Figure 11：BER-SNR 性能曲线（10-30 dB，步进 2 dB）
- Figure 12：发送/接收信号局部窗口时域对比（并打印窗口内 SNR/MSE）
- Figure 13：与 Figure 12 同一窗口的双边谱对比（包含均衡前后的频谱）
- Figure 14：信道估计结果可视化（如果使用导频均衡）
- Figure 15：接收端 16QAM 星座图（均衡后，如果使用导频均衡）
- Figure 16：CP 相关性检测结果可视化（增强版）
  - 子图1：CP 相关性检测（峰值位置、多个峰值标记、检测阈值）
  - 子图2：相位差（用于 CFO 估计，包含多个峰值的 CFO 估计）
  - 子图3：接收信号频谱（3dB带宽、有效带宽、90%功率带宽，含载波频率标记）
  - 子图4：功率度量（CP 和符号尾部的平均功率）

---

### 常见问题（FAQ）

- **运行报 "RNG 与旧生成器冲突"**
  - 原因：在 MATLAB 会话中曾调用过 `rand('state',...)` / `rand('twister',...)`。
  - 解决：在运行脚本前调用 `rng('default');`，或重启 MATLAB 再运行。

- **星座图发散或 BER 异常高**
  - 检查 `targetSNRdB` 是否过低；检查载波映射与 IFFT 长度是否匹配；确保依赖函数存在且无改动。

- **CFO 是什么？**
  - **CFO** 全称是 **Carrier Frequency Offset**（载波频率偏移）
  - 定义：接收端载波频率与发送端载波频率之间的偏差
  - 产生原因：
    1. 本地振荡器频率不匹配
    2. 多普勒频移（移动通信）
    3. 时钟漂移
  - 在 OFDM 系统中的作用：
    - CFO 会导致子载波间干扰（ICI）和符号间干扰（ISI）
    - 需要估计并补偿 CFO 以正确解调
    - 在代码中，通过循环前缀（CP）相关性检测来估计 CFO
  - 表示方式：
    - **归一化 CFO**：以子载波间隔的倍数表示
    - **绝对 CFO**：以 Hz 为单位表示

- **为什么采样频率没有信号带宽的两倍大？**
  - **奈奎斯特定理要求**：采样频率 ≥ 2 × 信号带宽（对于实信号）
  - **本系统的情况**：
    - 采样频率：fs = 15.36 MHz
    - 理论信号带宽：300 × 15 kHz = 4.5 MHz
    - 采样频率/理论带宽 = 15.36 / 4.5 = **3.41倍** ✓
    - **实际上采样频率是满足奈奎斯特定理的**（大于2倍带宽）
  - **可能的原因**（如果看到"采样频率没有信号带宽的两倍大"）：
    1. **检测到的带宽偏大**：检测算法可能包含噪声或频谱泄露
    2. **OFDM 系统的特殊性**：采样频率通常设计为 `fs = IFFT点数 × 子载波间隔 = 1024 × 15 kHz = 15.36 MHz`
    3. **检测算法的影响**：3dB带宽、有效带宽、90%功率带宽的定义不同，检测值可能比理论带宽大
  - **代码中的验证**：系统参数输出会显示采样频率与检测带宽的比值，以及是否满足奈奎斯特定理

---

### 性能建议
- 将 `total_symbols` 适当增大以获得更稳定的 BER 统计，但运行时间会增加。
- 需要更快速度时，可关闭部分绘图或减少 `total_symbols`。

---

### 文件清单（与本脚本相关）
- `test2.m`：主仿真脚本（本文件说明对应）
- `qam16.m`：16QAM 调制
- `demoduqam16.m`：16QAM 解调
- `rcoswindow.m`：升余弦窗生成
- `jakesChannel.m`：Jakes 瑞利衰落信道（如果使用瑞利衰落）
- `pilot_equalization.m`：导频辅助信道估计与均衡（如果使用导频均衡）

---

如需进一步说明或扩展（如多径信道、均衡、编码/交织），可在现有流程基础上添加相应模块。祝你仿真顺利！


