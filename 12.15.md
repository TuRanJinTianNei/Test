# 功率谱密度与带宽估计函数关系说明

**创建日期**: 2025.12.15
**版本**: 1.0

---

## 📋 目录

1. [概述](#概述)
2. [函数关系图](#函数关系图)
3. [核心函数说明](#核心函数说明)
4. [工作流程](#工作流程)
5. [使用示例](#使用示例)
6. [数据流](#数据流)
7. [文件依赖关系](#文件依赖关系)

---

## 概述

本文档说明与OFDM信号功率谱密度（PSD）估计和带宽估计相关的函数之间的关系。这些函数构成了一个完整的信号处理和分析系统，从信号生成到带宽估计的完整流程。

### 主要功能模块

1. **信号生成模块**: 生成OFDM发送和接收信号
2. **PSD估计模块**: 使用Welch算法和AR模型法估计功率谱密度
3. **带宽估计模块**: 从PSD估计信号带宽（多种方法）
4. **测试和示例模块**: 提供测试脚本和使用示例

---

## 函数关系图

```
┌─────────────────────────────────────────────────────────────┐
│                    信号生成层                                │
│                                                             │
│  signalGenerate.m                                          │
│  ├─ 生成OFDM发送信号 (Tx_data)                            │
│  ├─ 通过瑞利衰落信道                                       │
│  └─ 添加AWGN噪声 → 接收信号 (Rx_data)                     │
└────────────────────┬──────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  PSD估计层                                  │
│                                                             │
│  estimateBandwidthPSD.m                                    │
│  ├─ Welch算法PSD估计 → Pxx_welch, f_welch                │
│  └─ AR模型法PSD估计 → Pxx_ar, f_ar                        │
│                                                             │
│  输出: 功率谱密度（dB，归一化）                            │
└────────────────────┬──────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                  带宽估计层                                 │
│                                                             │
│  estimateBandwidthFromPSD.m                                │
│  ├─ 阈值法 (threshold)                                      │
│  ├─ 能量百分比法 (energy)                                  │
│  ├─ 峰值下降法 (peak_drop)                                 │
│  ├─ RMS带宽法 (rms)                                        │
│  └─ 积分法 (integral)                                      │
│                                                             │
│  输出: 估计带宽 (Hz)                                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              测试和示例层                                    │
│                                                             │
│  test_estimateBandwidthPSD.m                               │
│  ├─ 测试PSD估计                                            │
│  └─ 保存PSD数据到.mat文件                                  │
│                                                             │
│  example_bandwidthEstimation.m                             │
│  └─ 演示多种带宽估计方法的使用                             │
│                                                             │
│  测试AR和Welch/estimateBandwidth.m                         │
│  └─ 完整流程：信号处理 + PSD估计 + 带宽估计                │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心函数说明

### 1. signalGenerate.m

**功能**: OFDM信号生成（可独立运行）

**主要作用**:

- 生成完整的OFDM发送信号（基带实信号）
- 支持16QAM调制、IFFT、循环前缀、升余弦加窗
- 通过瑞利衰落信道和AWGN噪声生成接收信号

**输出变量**:

- `Tx_data`: 发送信号（基带实信号）
- `Rx_data`: 接收信号（经过信道和噪声）
- `fs`: 采样频率（15.36 MHz）
- `targetSNRdB`: 目标SNR（dB）
- `carrier_count`: 子载波数（300）
- `subcarrier_spacing`: 子载波间隔（15 kHz）

**关键特性**:

- 使用共轭对称映射实现实信号
- LTE风格的符号重叠相加机制
- 自动保存信号到.mat文件

**依赖关系**:

- `jakesChannel.m`: 瑞利衰落信道
- `qam16.m`: 16QAM调制（可选）

---

### 2. estimateBandwidthPSD.m

**功能**: 功率谱密度估计函数

**主要作用**:

- 使用Welch算法估计PSD（周期图平均法）
- 使用AR模型法估计PSD（Burg算法）
- 输出归一化的功率谱密度（dB单位）

**输入参数**:

- `sig_processed`: 已处理的信号（实数信号）
- `fs`: 采样频率（Hz）
- `snr`: 信噪比（dB，用于绘图标题）
- 可选参数: `plot`, `welch_window`, `welch_overlap`, `welch_nfft`, `ar_criterion`

**输出参数**:

- `Pxx_welch`: Welch算法PSD估计值（dB，归一化）
- `f_welch`: Welch算法对应的频率向量（Hz，0到fs/2）
- `Pxx_ar`: AR模型PSD估计值（dB，归一化）
- `f_ar`: AR模型对应的频率向量（Hz，0到fs/2）

**算法说明**:

- **Welch算法**: 使用 `pwelch`函数，默认参数：hanning窗100点，重叠55点，FFT 8192点
- **AR模型法**: 使用Burg算法，自动选择模型阶数（AIC或FPE准则）
- 输出为**单边谱**（0到fs/2），已自动转换

**内部函数**:

- `Burg()`: Burg算法实现AR模型功率谱估计
- `computeARpara()`: 计算AR模型参数

**依赖关系**:

- MATLAB信号处理工具箱（`pwelch`, `hanning`, `freqz`）

---

### 3. estimateBandwidthFromPSD.m

**功能**: 从功率谱密度估计带宽

**主要作用**:

- 提供5种不同的带宽估计方法
- 支持单一方法或所有方法对比
- 返回详细的估计结果

**输入参数**:

- `Pxx`: 功率谱密度（dB，归一化）
- `f`: 对应的频率向量（Hz）
- 可选参数: `method`, `threshold`, `energy_percent`, `peak_drop_db`, `plot`

**输出参数**:

- `B_estimated`: 估计的带宽（Hz）
- `results`: 详细结果结构体（包含上下边界、峰值频率等）

**支持的估计方法**:

| 方法          | 说明                                                        | 适用场景                         |
| ------------- | ----------------------------------------------------------- | -------------------------------- |
| `threshold` | 阈值法：在PSD上找到固定阈值（如-3dB）对应的频率边界         | 高SNR，简单快速                  |
| `energy`    | 能量百分比法：计算包含指定百分比（如90%）信号能量的频率范围 | 物理意义明确，适合能量集中的信号 |
| `peak_drop` | 峰值下降法：从峰值功率下降固定dB值作为阈值                  | 自适应阈值，相对峰值             |
| `rms`       | RMS带宽法：基于功率谱的二阶矩计算RMS带宽                    | 基于统计特性，适合高斯型频谱     |
| `integral`  | 积分法：基于累积功率分布确定带宽边界                        | 鲁棒性较好，对噪声不敏感         |
| `all`       | 使用所有方法并计算平均值                                    | 最佳实践，选择最稳定的方法       |

**使用示例**:

```matlab
% 单一方法
[B, results] = estimateBandwidthFromPSD(Pxx, f, 'method', 'threshold', 'threshold', -3);

% 所有方法对比
[B_all, results_all] = estimateBandwidthFromPSD(Pxx, f, 'method', 'all');
```

**依赖关系**:

- 输入来自 `estimateBandwidthPSD.m` 的输出

---

### 4. test_estimateBandwidthPSD.m

**功能**: 测试PSD估计函数

**主要作用**:

- 测试 `estimateBandwidthPSD.m` 函数
- 从.mat文件加载信号或自动生成信号
- 保存PSD估计结果到.mat文件

**工作流程**:

1. 加载或生成OFDM信号
2. 调用 `estimateBandwidthPSD.m` 进行PSD估计
3. 显示PSD特征（峰值频率、峰值功率等）
4. **保存PSD数据到.mat文件**（新增功能）
5. 绘制PSD对比图

**保存的.mat文件**:

- 文件名格式: `PSD_SNR{SNR值}dB_{子载波数}subcarriers_{日期时间}.mat`
- 包含变量: `Pxx_welch`, `f_welch`, `Pxx_ar`, `f_ar`, `fs`, `targetSNRdB`, `carrier_count`, `subcarrier_spacing`, `B_ideal`, 峰值信息等

**依赖关系**:

- `signalGenerate.m`: 生成信号（备用）
- `estimateBandwidthPSD.m`: PSD估计

---

### 5. example_bandwidthEstimation.m

**功能**: 带宽估计方法示例

**主要作用**:

- 演示如何使用 `estimateBandwidthFromPSD.m`
- 展示所有5种带宽估计方法
- 对比各方法的估计结果和误差

**工作流程**:

1. 生成或加载OFDM信号
2. 估计功率谱密度
3. 使用5种方法分别估计带宽
4. 使用"all"方法进行自动对比
5. 显示结果汇总和性能分析
6. 绘制综合对比图

**输出**:

- 命令窗口显示各方法的估计结果和误差
- 生成包含6个子图的对比图窗口

**依赖关系**:

- `signalGenerate.m`: 生成信号
- `estimateBandwidthPSD.m`: PSD估计
- `estimateBandwidthFromPSD.m`: 带宽估计

---

### 6. 测试AR和Welch/estimateBandwidth.m

**功能**: 完整的带宽估计流程（包含信号处理）

**主要作用**:

- 完整的带宽估计流程：信号处理 + PSD估计 + 带宽估计
- 支持从 `signalGenerate.m` 生成的基带信号开始
- 包含上变频、瑞利衰落信道、加噪声等处理步骤
- 计算带宽检测率（不同SNR下的性能）

**工作流程**:

1. 获取或生成基带信号（`Tx_data`）
2. 信号预处理（上变频、瑞利衰落、加噪声）
3. 使用 `PSD_OFDM_rayleigh` 函数进行PSD估计和带宽计算
4. 计算不同SNR下的带宽检测率
5. 绘制结果图形

**关键特性**:

- 支持无参数调用（自动从workspace获取或生成信号）
- 包含信号重采样功能（适配不同采样频率）
- 计算Rayleigh信道下的带宽检测率

**内部函数**:

- `PSD_OFDM_rayleigh()`: PSD估计和带宽计算（Rayleigh信道）
- `Bandwidth_rate_rayleigh()`: 带宽检测率计算
- `Burg()`: AR模型功率谱估计
- `MUL_RAYLEIGH()`: 多径瑞利衰落信道

**依赖关系**:

- `signalGenerate.m`: 生成基带信号
- 内部实现PSD估计和带宽计算（不依赖 `estimateBandwidthPSD.m`）

---

## 工作流程

### 流程1: 基本PSD估计和带宽估计

```
signalGenerate.m
    ↓
生成 Rx_data (接收信号)
    ↓
estimateBandwidthPSD.m
    ↓
估计 PSD (Pxx_welch, f_welch, Pxx_ar, f_ar)
    ↓
estimateBandwidthFromPSD.m
    ↓
估计带宽 (B_estimated)
```

### 流程2: 使用保存的PSD数据

```
test_estimateBandwidthPSD.m
    ↓
保存 PSD 到 .mat 文件
    ↓
test_bandwidth_methods_comparison.m
    ↓
从 .mat 文件加载 PSD
    ↓
estimateBandwidthFromPSD.m
    ↓
估计带宽 (多种方法对比)
```

### 流程3: 完整流程（包含信号处理）

```
signalGenerate.m
    ↓
生成 Tx_data (基带信号)
    ↓
测试AR和Welch/estimateBandwidth.m
    ↓
信号处理 (上变频、瑞利衰落、加噪声)
    ↓
PSD估计和带宽计算 (内部实现)
    ↓
带宽检测率分析
```

---

## 使用示例

### 示例1: 基本使用流程

```matlab
% 步骤1: 生成信号
signalGenerate;

% 步骤2: 估计PSD
[Pxx_welch, f_welch, Pxx_ar, f_ar] = estimateBandwidthPSD(...
    Rx_data, fs, targetSNRdB, 'plot', true);

% 步骤3: 估计带宽（阈值法）
[B, results] = estimateBandwidthFromPSD(...
    Pxx_welch, f_welch, 'method', 'threshold', 'threshold', -3);

fprintf('估计带宽: %.3f MHz\n', B/1e6);
```

### 示例2: 使用保存的PSD数据

```matlab
% 步骤1: 加载PSD数据
load('PSD_SNR15.0dB_300subcarriers_20251215_203645.mat');

% 步骤2: 使用所有方法估计带宽
[B_all, results_all] = estimateBandwidthFromPSD(...
    Pxx_welch, f_welch, 'method', 'all', 'plot', true);

% 步骤3: 查看结果
fprintf('平均带宽: %.3f MHz\n', B_all.mean/1e6);
fprintf('标准差: %.3f MHz\n', B_all.std/1e6);
```

### 示例3: 运行测试脚本

```matlab
% 测试PSD估计并保存结果
test_estimateBandwidthPSD;

% 运行带宽估计示例
example_bandwidthEstimation;

% 对比多种带宽估计方法（使用保存的PSD数据）
test_bandwidth_methods_comparison;
```

---

## 数据流

### 数据格式说明

#### 1. 信号数据（signalGenerate.m输出）

- **Tx_data**: 发送信号（实数，行向量）
- **Rx_data**: 接收信号（实数，行向量）
- **采样频率**: 15.36 MHz
- **信号类型**: 基带OFDM信号（共轭对称映射）

#### 2. PSD数据（estimateBandwidthPSD.m输出）

- **Pxx_welch**: Welch算法PSD（dB，归一化，峰值在0dB）
- **f_welch**: 频率向量（Hz，范围：0到fs/2）
- **Pxx_ar**: AR模型PSD（dB，归一化，峰值在0dB）
- **f_ar**: 频率向量（Hz，范围：0到fs/2）

**注意**:

- PSD数据为**单边谱**（只包含正频率部分）
- 已自动进行单边谱转换（正频率部分幅度×2，除DC和Nyquist）

#### 3. 带宽估计结果（estimateBandwidthFromPSD.m输出）

- **B_estimated**: 估计带宽（Hz）
- **results结构体**:
  - `bandwidth`: 估计带宽（Hz）
  - `lower_freq`: 下边界频率（Hz）
  - `upper_freq`: 上边界频率（Hz）
  - `peak_freq`: 峰值频率（Hz）
  - `peak_power`: 峰值功率（dB）

---

## 文件依赖关系

### 依赖关系图

```
signalGenerate.m
├── jakesChannel.m (瑞利衰落信道)
└── qam16.m (16QAM调制，可选)

estimateBandwidthPSD.m
├── Burg() (内部函数)
└── computeARpara() (内部函数)

estimateBandwidthFromPSD.m
└── (独立函数，无外部依赖)

test_estimateBandwidthPSD.m
├── signalGenerate.m
└── estimateBandwidthPSD.m

example_bandwidthEstimation.m
├── signalGenerate.m
├── estimateBandwidthPSD.m
└── estimateBandwidthFromPSD.m

test_bandwidth_methods_comparison.m
├── signalGenerate.m (备用)
├── estimateBandwidthPSD.m (备用)
└── estimateBandwidthFromPSD.m

测试AR和Welch/estimateBandwidth.m
├── signalGenerate.m (可选)
├── PSD_OFDM_rayleigh() (内部函数)
├── Bandwidth_rate_rayleigh() (内部函数)
├── Burg() (内部函数)
├── MUL_RAYLEIGH() (内部函数)
└── Proximate() (内部函数)
```

### 关键依赖说明

1. **MATLAB工具箱依赖**:

   - 信号处理工具箱（Signal Processing Toolbox）
     - `pwelch`: Welch算法功率谱估计
     - `hanning`: 汉宁窗函数
     - `freqz`: 频率响应计算
   - 通信工具箱（Communications Toolbox，可选）
     - `qammod`: QAM调制（如果qam16.m不存在）
2. **自定义函数依赖**:

   - `jakesChannel.m`: Jakes瑞利衰落信道模型
   - `qam16.m`: 16QAM调制函数（可选）
   - `rcoswindow.m`: 升余弦窗函数（signalGenerate.m使用）

---

## 函数对比

### estimateBandwidthPSD.m vs 测试AR和Welch/estimateBandwidth.m

| 特性               | estimateBandwidthPSD.m    | estimateBandwidth.m              |
| ------------------ | ------------------------- | -------------------------------- |
| **功能**     | 仅PSD估计                 | PSD估计 + 带宽计算               |
| **输入**     | 已处理的信号              | 基带信号（需要上变频等处理）     |
| **输出**     | PSD数据                   | 带宽值                           |
| **信号处理** | 不包含                    | 包含（上变频、瑞利衰落、加噪声） |
| **带宽估计** | 不包含                    | 包含（阈值法）                   |
| **使用场景** | 已有接收信号，只需PSD估计 | 从基带信号开始的完整流程         |

### 推荐使用方式

1. **如果已有接收信号（Rx_data）**:

   - 使用 `estimateBandwidthPSD.m` 估计PSD
   - 使用 `estimateBandwidthFromPSD.m` 估计带宽（多种方法）
2. **如果从基带信号开始**:

   - 使用 `测试AR和Welch/estimateBandwidth.m` 完整流程
   - 或手动调用 `signalGenerate.m` → `estimateBandwidthPSD.m` → `estimateBandwidthFromPSD.m`
3. **如果需要保存和重用PSD数据**:

   - 使用 `test_estimateBandwidthPSD.m` 保存PSD
   - 使用 `test_bandwidth_methods_comparison.m` 加载PSD并估计带宽

---

## 常见问题

### Q1: 应该使用哪个函数进行PSD估计？

**A**:

- 如果已有接收信号（`Rx_data`），使用 `estimateBandwidthPSD.m`
- 如果从基带信号开始，可以使用 `测试AR和Welch/estimateBandwidth.m` 的内部函数，或先调用 `signalGenerate.m` 生成接收信号

### Q2: 如何选择带宽估计方法？

**A**:

- **高SNR（>10dB）**: 推荐阈值法或峰值下降法
- **低SNR（<5dB）**: 推荐能量法或积分法
- **需要统计特性**: 推荐RMS带宽法
- **最佳实践**: 使用 `'method', 'all'` 获取所有方法的结果，取平均值或选择最稳定的方法

### Q3: PSD数据是单边谱还是双边谱？

**A**:

- `estimateBandwidthPSD.m` 输出的是**单边谱**（0到fs/2）
- 已自动进行单边谱转换（正频率部分幅度×2，除DC和Nyquist频率）
- 这是MATLAB `pwelch` 函数的默认行为

### Q4: 如何保存和重用PSD数据？

**A**:

- 使用 `test_estimateBandwidthPSD.m` 会自动保存PSD数据到.mat文件
- 文件名格式: `PSD_SNR{SNR值}dB_{子载波数}subcarriers_{日期时间}.mat`
- 使用 `test_bandwidth_methods_comparison.m` 可以从.mat文件加载PSD数据

### Q5: 两个estimateBandwidth函数的区别？

**A**:

- `estimateBandwidthFromPSD.m`: 从PSD数据估计带宽，支持多种方法
- `测试AR和Welch/estimateBandwidth.m`: 完整流程，包含信号处理和带宽计算

---

## 更新日志

- **2025.12.15**: 创建文档，说明函数关系
- **2025.12.15**: 添加PSD数据保存功能（test_estimateBandwidthPSD.m）
- **2025.12.15**: 添加从.mat文件加载PSD功能（test_bandwidth_methods_comparison.m）

---

## 联系信息

如有问题或建议，请参考各函数的注释说明或联系项目维护者。

---

**文档结束**
