% ============================================================================
% 文件名: test3.m
% 功能: Wi‑Fi (802.11n/ac) 20 MHz OFDM子载波占用演示
% 描述:
%   1. 模拟802.11标准中的64点OFDM系统
%   2. 展示64个总子载波中的实际占用情况：
%      - 52个使用子载波：48个数据 + 4个导频
%      - 12个空子载波：包含DC=0与频谱两侧的保护带
%   3. 演示子载波索引映射（MATLAB IFFT bin与标准k索引的对应关系）
%   4. 生成3个Figure展示频域占用、时域波形和频谱验证
% 标准说明: N=64，总子载波64个，其中实际使用52个
%   - 48个数据(data) + 4个导频(pilots)
%   - 剩余12个为空子载波：包含DC=0与频谱两侧的保护带
% ============================================================================

clc; clear; close all;

%===============================================================================
% 【系统参数配置】
%===============================================================================
N = 64;                       % IFFT 大小
M = 4;                        % QPSK（每子载波2 bit），演示更直观
bits_per_symbol = log2(M);

%------------------------------------------------------------------------------
% 802.11标准子载波分配
%------------------------------------------------------------------------------
% 802.11 常用占用：±1..±26（去掉0），其中导频在 {-21,-7,7,21}
used_k = [-26:-1 1:26];             % 共52个（含4导频与48数据）
pilot_k = [-21 -7 7 21];
data_k  = setdiff(used_k, pilot_k);

%------------------------------------------------------------------------------
% 子载波索引映射（MATLAB IFFT bin与标准k索引的对应关系）
%------------------------------------------------------------------------------
% 将子载波指数k∈[-N/2+1, N/2-1] 映射到 MATLAB IFFT 输入索引（1..N，DC=1）
% 规则：k=0 → 1；k>0 → k+1；k<0 → N+k+1
map_k_to_bin = @(k) (k>0).*(k+1) + (k==0).*1 + (k<0).*(N+k+1);
used_bins  = arrayfun(map_k_to_bin, used_k);
pilot_bins = arrayfun(map_k_to_bin, pilot_k);
data_bins  = arrayfun(map_k_to_bin, data_k);
dc_bin = map_k_to_bin(0);

%===============================================================================
% 【频域构造与IFFT变换】
%===============================================================================

%------------------------------------------------------------------------------
% 步骤1: 构造频域OFDM符号
%------------------------------------------------------------------------------
X = zeros(1, N);

% 随机QPSK数据
num_data = numel(data_bins);
bits = randi([0 1], 1, num_data*bits_per_symbol);
% QPSK Gray 映射：00→1+1j, 01→-1+1j, 11→-1-1j, 10→1-1j（幅度归一化至单位能量）
bits2 = reshape(bits, 2, []).';
sym_map = (1 - 2*bits2(:,1)) + 1j*(1 - 2*bits2(:,2));
sym_map = sym_map / sqrt(2);

% 导频固定为+1（BPSK），与标准一致性无关，这里只为占位演示
X(pilot_bins) = 1;
X(data_bins)  = sym_map;
X(dc_bin)     = 0;   % DC 必为空

% 统计空子载波（保护带与DC）
all_bins = 1:N;
null_bins = setdiff(all_bins, [used_bins dc_bin]);   % 边缘保护带
null_bins = unique([null_bins dc_bin]);              % 将DC并入空子载波集合

%------------------------------------------------------------------------------
% 步骤2: IFFT变换（频域 → 时域）
%------------------------------------------------------------------------------
x = ifft(X, N);                % 单个OFDM时域符号（未加CP）

%===============================================================================
% 【可视化分析】
%===============================================================================

%------------------------------------------------------------------------------
% Figure 1: 频域占用图（幅度）
%------------------------------------------------------------------------------
figure(1);  % 频域占用图（幅度）
stem(0:N-1, abs(X), 'filled'); grid on; hold on;
xlabel('IFFT Bin (0..63)'); ylabel('|X[k]|');
title('802.11 64pt OFDM 子载波占用：数据48 + 导频4，空载波(含DC)12');

% 叠加导频与空子载波标记
hp = stem(pilot_bins-1, abs(X(pilot_bins)), 'r', 'filled');
hn = stem(null_bins-1, 0*null_bins, 'k.', 'DisplayName','Null (guards+DC)');

% 反向映射：bin -> 子载波索引 k（范围 -32..+31，k=0 为DC）
map_bin_to_k = @(b) (b==1).*0 + (b>1 & b<=N/2+1).*(b-1) + (b>N/2+1).*(b - N - 1);

% 文本标注：导频载波（显示其 k 值）
for ii = 1:numel(pilot_bins)
    b = pilot_bins(ii); k = map_bin_to_k(b);
    text(b-1, abs(X(b))+0.1, sprintf('P%+d', k), 'Color','r', 'FontSize',8, 'HorizontalAlignment','center');
end

% 文本标注：空子载波（保护带与DC）
for ii = 1:numel(null_bins)
    b = null_bins(ii); k = map_bin_to_k(b);
    if k==0
        lbl = 'DC(0)';
    else
        lbl = sprintf('G%+d', k);
    end
    text(b-1, 0.1, lbl, 'Color','k', 'FontSize',8, 'HorizontalAlignment','center', 'Rotation',90);
end

legend({'All |X|','Pilots','Null (guards+DC)'}, 'Location','best');
hold off;

%------------------------------------------------------------------------------
% Figure 2: 时域波形（实部/幅度）
%------------------------------------------------------------------------------
figure(2);  % 时域波形（实部/幅度）
subplot(2,1,1);
plot(0:N-1, real(x), 'b-'); grid on; xlabel('n'); ylabel('Re{x[n]}');
title('时域OFDM符号（未加CP）');
subplot(2,1,2);
plot(0:N-1, abs(x), 'm-'); grid on; xlabel('n'); ylabel('|x[n]|');

%------------------------------------------------------------------------------
% Figure 3: 频谱验证（IFFT→FFT 验证频谱占用）
%------------------------------------------------------------------------------
figure(3);  % 频谱（幅度，0~N-1）
X_est = abs(fft(x, N));
plot(0:N-1, 20*log10(X_est+eps)); grid on;
xlabel('Bin'); ylabel('Magnitude (dB)');
title('IFFT→FFT 验证频谱占用（应与构造的 |X| 一致）');

%===============================================================================
% 【命令行输出摘要】
%===============================================================================
fprintf('\n==== 802.11 20MHz / N=64 占用概览 ====\n');
fprintf('Total subcarriers : %d\n', N);
fprintf('Used (data+pilot) : %d (data=%d, pilots=%d)\n', numel(used_bins), numel(data_bins), numel(pilot_bins));
fprintf('Null (guards+DC)  : %d\n', numel(null_bins));
fprintf('Null includes DC? : yes (bin=%d)\n', dc_bin-1);
fprintf('Pilot bins (0-based): ');
fprintf('%d ', pilot_bins-1); fprintf('\n');
fprintf('Example data bins (0-based, first 10): ');
fprintf('%d ', (data_bins(1:min(10,end))-1)); fprintf('\n');
fprintf('=======================================\n\n');


