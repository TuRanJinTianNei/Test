### test4.m 使用说明（README）

`test4.m` 是一个 OFDM 链路仿真脚本（16QAM → IFFT → CP → AWGN → 去CP/FFT → 解调/BER）。**本脚本重点展示"无加窗、无后缀、无重叠"的简化 OFDM 系统实现，用于对比"无加窗/无重叠"的串接与频谱/BER 表现。**

---

### 快速运行

1. 在 MATLAB 中将当前路径切换到脚本所在目录。
2. 运行：
   ```matlab
   test4
   ```
3. 脚本将自动生成 13 个 Figure 图形，并在命令行输出仿真摘要和 BER-SNR 曲线数据。

---

### 关键参数（与含义）

#### 基本时间/频率与调制参数
- `subcarrier_spacing = 15e3`：子载波间隔 15 kHz（符合 LTE 标准）
- `fs = 15.36e6`：采样频率 15.36 MHz
- `symbol_duration = 1/subcarrier_spacing`：有效符号时长约 66.67 μs
- `modulation_order = 16`，`bits_per_symbol = 4`：16QAM 调制，每子载波承载 4 比特

#### IFFT 与数据规模参数
- `IFFT_bin_length = 1024`：IFFT 点数（记为 N）
- `carrier_count = 300`：仅正频率数据子载波数量（负频率由其镜像共轭生成）
  - 占用子载波（含 DC）= 2×300 + 1 = **601**
  - 保护子载波数 = 1024 − 601 = **423**
- `total_symbols = 100`：仿真符号数（用于串行拼接并加噪分析）
- `symbols_per_frame = 50`：每帧包含的 OFDM 符号数（便于按帧组织串行信号）

#### CP 参数（无加窗、无后缀、无重叠）
- **循环前缀（CP）**：
  - `GI = 72`：保护前缀长度（样本数，**固定值**）
  - `PrefixRatio = 72 / IFFT_bin_length = 72/1024 ≈ 0.0703`：循环前缀比例
  - CP 的作用：对抗多径干扰，保持符号间正交性

- **加窗参数（本配置不加窗、不重叠）**：
  - `beta = 0`：**不加窗**（滚降系数为 0）
  - `GIP = 0`：**无后缀**（无重叠）
  - 单个符号的时域结构：`[CP(GI=72) | 主体(N=1024)]`，总长度 = **1096** 样本
  - **符号间直接串接，无重叠相加**

#### 信道与性能评估参数
- `targetSNRdB = 15`：目标信噪比（dB），用于 15 dB 下的详细分析
- BER-SNR 曲线计算范围：10-30 dB，步进 2 dB（共 11 个 SNR 点）

#### 随机性与可复现性
- 默认：`rng('default'); rng('shuffle');` 每次运行产生不同比特与噪声
- 复现实验：可改为 `rng(固定种子,'twister');` 后再运行

---

### 子载波的 IFFT 点数分配（频域映射，N=1024）

为生成实值时域信号，脚本采用"厄米共轭对称"频谱，并将 DC（直流）置零。采用"正频率放数据、负频率放镜像"的通用映射方式：

#### 1) 子载波组织
- **正频率数据子载波数量**：`carrier_count = 300`
- **负频率子载波**：为正频率的镜像共轭，不携带独立数据（满足 `X[k] = conj(X[N-k+2])`）
- **DC（直流）bin**：置 0
- **未占用的 bin**：置 0（保护带/空子载波）

#### 2) MATLAB IFFT bin（从 1 开始）的典型分布
- **正频率数据子载波 bin**：以系统居中方式放置在 N/4 附近的连续 300 个位置
  - 计算公式：`carriers = (1:carrier_count) + (floor(N/4)-floor(carrier_count/2))`
- **负频率镜像 bin**：`conjugate_carriers = N - carriers + 2`
- **DC bin = 1**：置 0

#### 3) 频域矩阵构造
- 将一符号的 300 个复数据载波写入正频率 `carriers`
- 将其"镜像共轭"写入 `conjugate_carriers`，满足 `X[k] = conj(X[N-k+2])`
- IFFT 后得到"近似实值"时域符号（考虑数值误差，脚本中按需取实部处理）

#### 4) 占用与保护带（按当前参数）
- **占用子载波（含 DC）**：601
- **保护子载波**：423（其余 bin）

---

### 发送端到接收端流程详解

#### 【发送端处理流程】

1. **随机比特流生成**
   - 生成 `baseband_out_length = carrier_count * total_symbols * bits_per_symbol = 300 * 100 * 4 = 120,000` 比特

2. **16QAM 调制**
   - 调用 `qam16()` 函数将比特流映射为复值符号
   - 每个符号对应 4 比特，共 30,000 个复值符号
   - 重塑为 `[total_symbols × carrier_count]` 矩阵

3. **频域子载波映射（构造厄米共轭对称）**
   - 将复值符号写入正频率 `carriers` 位置
   - 将共轭镜像写入负频率 `conjugate_carriers` 位置
   - DC bin 置 0，其余 bin 置 0（保护带）

4. **IFFT 变换（频域 → 时域）**
   - 对每个符号进行 1024 点 IFFT，得到时域 OFDM 符号（未加保护间隔）

5. **添加循环前缀（CP）**
   - 符号主体部分（中间）：1024 个样本
   - 循环前缀：将符号尾部 72 个样本复制到开头
   - **无后缀**：GIP = 0
   - 符号结构：`[CP(72) | 主体(1024)]`

6. **OFDM 符号处理（本配置不加窗）**
   - **不进行任何加窗处理**，直接使用含 CP 的符号序列
   - `windowed_time_wave_matrix_cp = time_wave_matrix_cp`（直接赋值，无窗函数应用）

7. **生成发送信号，并串变换（按帧组织，直接串接）**
   - 按帧组织：每帧包含 50 个符号
   - **直接串接机制**：
     - 每个符号直接按顺序串接，**无重叠相加**
     - 因为 GIP=0，所以没有重叠处理逻辑
   - 每帧串行长度：`frame_len_CP_suffix = symbols_per_frame*(N+GI) + GIP = 50*(1024+72) + 0 = 54,800` 样本

#### 【信道传输】

8. **AWGN 加性高斯白噪声信道**
   - 根据目标 SNR（15 dB）和发送信号功率计算噪声方差
   - 添加高斯白噪声：`Rx_data = Tx_data + noise`

#### 【接收端处理流程】

9. **串并转换，去除循环前缀（无后缀）**
   - 按帧切分接收信号
   - 对每个符号：提取 `[CP(GI) | 主体(N)]` 结构（无后缀）
   - **去除 CP**：只保留主体部分（N=1024 个样本）进行 FFT 解调

10. **FFT 解调（时域 → 频域），提取子载波数据**
    - 对每个符号的主体部分（1024 点）进行 FFT
    - 提取正频率 `carriers` 位置的子载波数据

11. **16QAM 解调（最小欧氏距离判决）**
    - 调用 `demoduqam16()` 函数进行解调判决
    - 将复值符号映射回比特流

12. **误码率计算**
    - 对比发送和接收比特流，计算误码率（BER）
    - 在 15 dB SNR 下进行详细分析
    - 在 10-30 dB 范围内（步进 2 dB）计算 BER-SNR 曲线

---

### 主要图形输出（13 个 Figure）

#### 【一】单符号分析与可视化
- **Figure 1**：IFFT 各频点幅度
  - 展示激活的子载波与其共轭镜像的幅度分布
  - 可直观看到载波分配与未用频点（幅度为 0）

- **Figure 2**：IFFT 各频点相位（度）
  - 体现共轭映射带来的相位对称性
  - 验证实值时域信号条件

- **Figure 3**：单符号时域（未加 CP/后缀）
  - 展示 IFFT 输出的一个符号周期包络与幅度范围

- **Figure 4**：单符号时域（加 CP）
  - 左侧 CP（72 样本）
  - **无后缀**（GIP=0）

- **Figure 5**：单符号时域（"加窗后"，实际未加窗）
  - 注意：虽然标题提到"加窗"，但本配置实际**不加窗**
  - 符号结构：`[CP(72) | 主体(1024)]`

#### 【二】帧级、串行信号与频谱分析
- **Figure 6**：串行发送时域对比
  - 子图(1)：将每个符号（含 CP）直接串接
  - 子图(2)：帧级串行信号（无重叠，无后缀）

- **Figure 7**：加窗前后局部窗口时域对比（与 Figure 12 相同范围）
  - 注意：本配置中"加窗信号"实际等同于"未加窗信号"（因为 beta=0）
  - 展示信号在局部窗口内的时域波形

- **Figure 8**：加窗前后局部窗口频域对比（与 Figure 12 相同范围，双边谱）
  - 注意：本配置中"加窗信号"实际等同于"未加窗信号"（因为 beta=0）
  - 展示信号在局部窗口内的幅度谱（dB 值）

#### 【三】信道影响与接收端评估
- **Figure 12**：局部窗口时域对比（含 SNR/MSE 命令行打印）
  - 子图(1)：发送信号（局部放大）
  - 子图(2)：接收信号（局部放大）
  - 命令行输出：窗口范围、信号功率、噪声功率、SNR、MSE

- **Figure 13**：局部窗口双边谱对比
  - 子图(1)：发送信号频谱（双边谱，局部放大）
  - 子图(2)：接收信号频谱（双边谱，局部放大）

#### 【四】解调判决与性能
- **Figure 9**：接收端 16QAM 星座图（IQ 平面）
  - SNR 越高散点越集中于 16QAM 理想点

- **Figure 10**：比特流发/收前 100 位对比
  - 子图(1)：发送比特流（前 100 位）
  - 子图(2)：接收比特流（前 100 位）

- **Figure 11**：BER-SNR 曲线（10-30 dB，步进 2 dB）
  - 对数坐标显示误码率性能
  - 包含 11 个 SNR 点的 BER 计算结果

---

### 命令行输出信息

脚本运行时会输出以下关键信息：

1. **局部窗口指标（Figure 12）**：
   - 窗口范围、长度
   - 信号功率、噪声功率
   - SNR（Tx vs Rx）、MSE（Tx vs Rx）

2. **仿真摘要（SNR = 15 dB）**：
   - IFFT 长度（N）
   - CP 长度（GI）、比例
   - **符号结构**：`[CP(GI) | N], no window, no overlap`（明确标注无加窗、无重叠）
   - 激活子载波数、占用子载波（含 DC）、保护子载波
   - 总符号数、总比特数
   - 发送功率、噪声方差
   - BER（15 dB 下的误码率）
   - 单个 OFDM 符号长度（N+GI）

3. **BER-SNR 曲线计算过程**：
   - 逐个 SNR 点（10-30 dB，步进 2 dB）的 BER 计算结果

---

### 关键特性说明

#### 1. 无加窗、无重叠的简化实现
- **符号结构简单**：每个符号仅由 `[CP(GI) | 主体(N)]` 组成，无后缀
- **直接串接**：符号间直接按顺序串接，无重叠相加操作
- **实现简单**：无需处理窗函数和重叠逻辑，代码更简洁

#### 2. 与 test3.m 的对比
- **CP 长度**：test4.m 使用固定 CP 长度（72），test3.m 使用比例 CP（256）
- **加窗处理**：test4.m 不加窗，test3.m 使用升余弦窗
- **符号结构**：test4.m 无后缀，test3.m 有后缀（GIP=80）
- **串接方式**：test4.m 直接串接，test3.m 重叠相加
- **频谱特性**：test4.m 可能具有较高的频谱旁瓣，test3.m 旁瓣较低

#### 3. 应用场景
- **简化实现场景**：适用于不需要低频谱泄露的应用
- **对比研究**：用于对比"无加窗/无重叠"对性能与频谱的影响
- **快速原型**：作为 OFDM 系统的简化版本，便于快速验证基本功能

#### 4. 潜在影响
- **频谱旁瓣**：无加窗可能导致符号边缘存在陡峭跳变，频谱旁瓣较高
- **带外辐射**：可能产生较高的带外辐射（频谱泄露）
- **符号间干扰**：直接串接可能在符号边界处产生不连续性

---

### 小贴士

- **想要更快运行**：减少 `total_symbols` 或关闭部分绘图（注释掉 figure 相关代码）
- **想要更稳定的 BER 统计**：增大 `total_symbols`（运行时间相应增加）
- **想要对比加窗效果**：可参考 test3.m，对比加窗前后的频谱和 BER 性能
- **想要复现实验**：将 `rng('default'); rng('shuffle');` 改为 `rng(固定种子,'twister');`
- **想要调整 CP 长度**：直接修改 `GI` 值（注意保持为整数）
- **想要观察符号边界**：查看 Figure 6，观察符号连接处的波形

---

### 与 test3.m 的对比建议

建议同时运行 test3.m 和 test4.m，对比以下方面：

1. **频谱特性**：
   - 对比 Figure 8 和 Figure 13 的频谱图
   - 观察加窗对旁瓣的抑制效果

2. **BER 性能**：
   - 对比 Figure 11 的 BER-SNR 曲线
   - 分析加窗对误码率的影响（通常影响较小，主要在频谱特性）

3. **实现复杂度**：
   - 对比代码复杂度（test4.m 更简单）
   - 对比运行时间（test4.m 可能稍快）

4. **符号结构**：
   - 对比符号长度（test3.m: 1360 样本，test4.m: 1096 样本）
   - 对比 CP 长度（test3.m: 256，test4.m: 72）

---

### 扩展建议

如需扩展功能，可在现有结构上逐步添加：
- **多径信道**：在 AWGN 信道后添加多径衰落模型
- **信道均衡**：在 FFT 解调后添加均衡器（如 MMSE、ZF）
- **信道编码/交织**：在 16QAM 调制前添加编码，在解调后添加解码
- **同步**：添加符号同步、频率同步模块
- **加窗功能**：参考 test3.m，添加升余弦加窗和重叠相加机制
- **其他调制方式**：修改 `qam16()` 和 `demoduqam16()` 调用，支持 QPSK、64QAM 等

祝你仿真顺利！
