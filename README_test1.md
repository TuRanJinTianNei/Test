### test1.m 使用说明（README）

`test1.m` 是一个基于 LTE 思路实现的 OFDM 发射-信道-接收端完整仿真脚本，包含：
- 16QAM 比特映射与子载波映射（采用频域共轭对称，保证 IFFT 输出为实信号）
- IFFT 生成时域符号、添加循环前缀（固定 CP 长度）与升余弦加窗
- 帧/串行信号构造（在 CP 范围内进行重叠相加，降低旁瓣）
- Jakes 瑞利衰落信道 + AWGN 信道
- 导频辅助信道估计与均衡
- 接收端去 CP → FFT → 信道估计与均衡 → 解调判决、误码率计算
- 多幅图形用于观测频域/时域/频谱、星座图、发收比特、BER-SNR 性能曲线等

---

### 环境要求
- MATLAB R2016a 或更高版本（建议更高版本）
- 同目录下依赖函数：
  - `qam16.m`（16QAM 映射）
  - `demoduqam16.m`（16QAM 判决解调）
  - `rcoswindow.m`（升余弦窗）
  - `jakesChannel.m`（Jakes 瑞利衰落信道）
  - `pilot_equalization.m`（导频辅助信道估计与均衡）

---

### 运行方法
1. 打开 MATLAB，将当前工作目录切换到本脚本所在路径。
2. 直接运行：
   ```matlab
   test1
   ```

---

### 关键可调参数（在脚本顶部附近）
- **基本频率参数**：
  - `subcarrier_spacing = 15e3`：子载波间隔（15 kHz）
  - `fs = 15.36e6`：采样频率（15.36 MHz）
- **IFFT/FFT 参数**：
  - `IFFT_bin_length = 1024`：IFFT 点数
- **子载波配置**：
  - `carrier_count = 300`：有效数据子载波数（正频率数据，负频率为镜像）
  - 占用子载波总数：2×300 + 1(DC) = 601 个
  - 空子载波数：1024 - 601 = 423 个（保护带）
- **CP 配置**：
  - `GI = 72`：循环前缀长度（固定 CP，样本数）
  - `PrefixRatio = 72/1024`：循环前缀比例
- **加窗配置**：
  - `beta = 1/16`：加窗滚降系数
  - `GIP`：后缀长度（自动计算，不超过 CP 长度）
- **符号数与比特数**：
  - `total_symbols = 100`：总符号数
  - `symbols_per_frame = 50`：每帧符号数
  - `bits_per_symbol = 4`：每个子载波承载的比特数（16QAM）
- **信道参数**：
  - `targetSNRdB = 15`：目标信噪比（dB），用于详细分析
  - `use_rayleigh_fading = true`：是否使用瑞利衰落信道
  - `fd = 100`：最大多普勒频移（Hz）
- **导频均衡参数**：
  - `use_pilot_equalization = true`：是否使用导频均衡
  - `pilot_spacing = 6`：导频间隔（每隔 6 个子载波插入一个导频）
  - `interpolation_method = 'linear'`：插值方法（'linear' 或 'spline'）

提示：以上参数均可直接在脚本中修改后再次运行生效。

---

### 随机性与复现
- 本脚本每次运行都会随机生成新的发射比特与噪声：
  ```matlab
  rng('shuffle');  % 基于当前时间设置随机种子，确保每次运行都不同
  baseband_out = randi([0 1], 1, baseband_out_length);
  ```
- 如需复现实验（固定随机序列），可将上述行替换为固定种子，例如：
  ```matlab
  rng(20251116,'twister');  % 任意固定整数种子
  baseband_out = randi([0 1], 1, baseband_out_length);
  ```
- 注意：每次 BER-SNR 曲线计算循环中，都会生成新的随机噪声，确保每个 SNR 点的噪声样本都是独立的。

---

### 帧结构与 CP 设计
- **CP 作用**：循环前缀等效于在符号前复制尾部一段，用于对抗多径时延扩展并保持子载波正交，避免符号间干扰（ISI）和子载波间干扰（ICI）。
- **固定 CP 长度**：本脚本采用固定 CP 长度 `GI = 72`，适用于所有符号。
- **符号结构**：每个 OFDM 符号的结构为 `[CP(GI) | 主体(N) | 后缀(GIP)]`
  - CP 长度：`GI = 72` 个样本
  - 主体长度：`N = 1024` 个样本（IFFT 点数）
  - 后缀长度：`GIP` 个样本（用于加窗过渡，不超过 CP 长度）
- **加窗与重叠**：脚本在 CP 范围内进行升余弦窗的平滑过渡与"重叠相加"：
  - 使用升余弦窗（滚降系数 `beta = 1/16`）平滑符号边缘
  - 重叠相加：当前符号的后缀与下一个符号的 CP 前 GIP 个样本重叠相加
  - 保证过渡仅发生在 CP 内，不影响有效符号主体数据
  - LTE 风格：重叠区域限制在 CP 内，接收端去除 CP 时不受影响

---

### 输出图形（主要）
- **Figure 1**：IFFT 输入各频点幅度（展示子载波分配与空子载波）
- **Figure 9**：接收端 16QAM 星座图（均衡前）
- **Figure 10**：发/收比特流前 100 位对比
- **Figure 11**：BER-SNR 性能曲线（10-30 dB，步进 2 dB）
- **Figure 12**：发送/接收信号局部窗口时域对比（并打印窗口内 SNR/MSE）
- **Figure 13**：与 Figure 12 同一窗口的双边谱对比（包含均衡前后的频谱）
- **Figure 14**：信道估计结果可视化（如果使用导频均衡）
- **Figure 15**：接收端 16QAM 星座图（均衡后，如果使用导频均衡）

**注意**：Figure 2-8 已被注释，如需查看可取消注释。

---

### 系统处理流程

#### 发送端处理
1. **随机比特流生成** → 生成数据子载波所需的比特数（考虑导频占用）
2. **16QAM 调制** → 将比特流映射为 16QAM 复符号
3. **导频插入** → 在数据子载波中插入导频符号
4. **频域子载波映射** → 构造埃尔米特共轭对称映射（正频率数据，负频率共轭镜像）
5. **IFFT 变换** → 频域 → 时域变换，输出实值 OFDM 符号
6. **添加循环前缀和后缀** → CP(72样本) + 主体(1024样本) + 后缀(GIP样本)
7. **LTE 风格加窗** → 升余弦窗平滑符号边缘，符号间重叠相加
8. **串并转换** → 按帧组织符号，帧内符号重叠相加

#### 信道传输
1. **Jakes 瑞利衰落信道** → 应用多径衰落
2. **AWGN 噪声** → 根据目标 SNR 计算噪声功率，添加高斯白噪声

#### 接收端处理
1. **串并转换** → 从串行序列中提取每个 OFDM 符号，去除 CP 和后缀
2. **FFT 解调** → 时域 → 频域变换，提取所有子载波的接收信号
3. **信道估计与均衡** → 使用导频进行信道估计，并进行频域均衡
4. **16QAM 解调** → 最小欧氏距离判决，恢复比特流
5. **误码率计算** → 对比发送和接收比特流，计算 BER

---

### 性能分析
- **BER-SNR 曲线**：程序计算 10-30 dB 范围内的 BER-SNR 曲线，步进 2 dB
- **命令行输出**：程序会输出详细的仿真摘要，包括：
  - 总符号数、总比特数、BER
  - 发送功率、噪声方差
  - IFFT 长度、激活子载波数、占用子载波数、保护子载波数
  - CP 长度、后缀长度、符号总长度
  - 加窗滚降系数、重叠长度
  - 信道类型（瑞利衰落 + AWGN）
  - 导频均衡状态

---

### 常见问题（FAQ）

- **运行报 "RNG 与旧生成器冲突"**
  - 原因：在 MATLAB 会话中曾调用过 `rand('state',...)` / `rand('twister',...)`。
  - 解决：在运行脚本前调用 `rng('default');`，或重启 MATLAB 再运行。

- **星座图发散或 BER 异常高**
  - 检查 `targetSNRdB` 是否过低；检查载波映射与 IFFT 长度是否匹配；确保依赖函数存在且无改动。

- **程序运行很慢？**
  - BER-SNR 曲线计算需要多次循环，这是正常的。可以减小 `total_symbols` 或 `SNR_range` 来加快速度。

- **内存不足？**
  - 可以减少 `total_symbols` 或 `SNR_range` 来降低内存需求。

---

### 性能建议
- 将 `total_symbols` 适当增大以获得更稳定的 BER 统计，但运行时间会增加。
- 需要更快速度时，可关闭部分绘图或减少 `total_symbols`。

---

### 文件清单（与本脚本相关）
- `test1.m`：主仿真脚本（本文件说明对应）
- `qam16.m`：16QAM 调制
- `demoduqam16.m`：16QAM 解调
- `rcoswindow.m`：升余弦窗生成
- `jakesChannel.m`：Jakes 瑞利衰落信道
- `pilot_equalization.m`：导频辅助信道估计与均衡

---

如需进一步说明或扩展（如多径信道、均衡、编码/交织），可在现有流程基础上添加相应模块。祝你仿真顺利！


