% ============================================================================
% 文件名: test4.m
% 功能: OFDM子载波正交性的连续频谱仿真演示
% 描述:
%   1. 展示OFDM子载波的sinc主瓣互在对方零点处对齐的正交特性
%   2. 说明为什么OFDM系统满足正交性条件（Δf=1/T）
%   3. 对比正交与非正交情况下的频谱重叠情况
%   4. 生成2个Figure：
%      - Figure 1: 正交情况下的连续频谱（各子载波零点对齐）
%      - Figure 2: 非正交情况下的频谱（出现ICI干扰）
% 原理: 矩形时窗T内的复指数 e^{j2πf_k t} 的频谱是 T·sinc((f-f_k)T)，
%      取 Δf=1/T，使不同子载波在彼此的中心处恰为零。
% 说明: 为什么有的OFDM系统频谱是离散的，有的是连续的？
%       - 连续频谱：看的是"单个OFDM符号的连续频谱形状"
%       - 离散频谱：看的是"离散频点上的采样值"
% ============================================================================

clc; clear; close all;

%===============================================================================
% 【系统参数配置】
%===============================================================================
T = 1;                      % 有效符号时长（不含CP），单位：归一化时间
df = 1/T;                   % 子载波间隔 Δf（满足正交条件）
k_set = -2:4;               % 展示的子载波索引（可改多一些）
colors = lines(numel(k_set));

% 连续频率网格（足够细），覆盖多个子载波带宽
f = linspace(-3*df, 6*df, 4000);

%===============================================================================
% 【连续频谱计算】
%===============================================================================

%------------------------------------------------------------------------------
% 步骤1: 计算每个子载波的连续幅度谱
%------------------------------------------------------------------------------
% MATLAB 的 sinc(x) = sin(pi*x)/(pi*x)
Sk = zeros(numel(k_set), numel(f));
for i = 1:numel(k_set)
    fk = k_set(i)*df;
    Sk(i,:) = abs(T * sinc((f - fk)*T));    % 幅度谱（不取dB便于形状观察）
end

%===============================================================================
% 【可视化分析】
%===============================================================================

%------------------------------------------------------------------------------
% Figure 1: 正交情况下的连续频谱（各子载波零点对齐）
%------------------------------------------------------------------------------
figure(1); hold on; grid on;
for i = 1:numel(k_set)
    plot(f/df, Sk(i,:), 'LineWidth', 1.6, 'Color', colors(i,:));
end
xlabel('f / \Delta f'); ylabel('|S_k(f)|');
title('OFDM 连续频谱：各子载波主瓣在对方零点处对齐（\Delta f = 1/T）');

% 标注各子载波中心位置与零点对齐示意
for i = 1:numel(k_set)
    xline(k_set(i), ':', sprintf('S_{%d}', k_set(i)), 'LabelVerticalAlignment','bottom');
end

% 在 f=0 处检查其它子载波的幅度（应≈0），并画红圈提示
f0_idx = dsearchn((f/df).', 0);
for i = 1:numel(k_set)
    if k_set(i) ~= 0
        plot(0, Sk(i,f0_idx), 'ro', 'MarkerSize', 6);
    end
end

% 画出 Δf 的示意箭头
yl = ylim; ymid = yl(1) + 0.1*(yl(2)-yl(1));
annotation('doublearrow', ...
    [(0.5) (0.5+1/(max(k_set)-min(k_set)+2))], ... % 近似比例定位
    [0.18 0.18]);
text(0.5, 0.2, '\Delta f', 'Units','normalized');

%------------------------------------------------------------------------------
% 验证：在 f=0 采样，各子载波除 k=0 外趋近0
%------------------------------------------------------------------------------
fprintf('\n在 f=0 处各子载波幅度：\n');
for i = 1:numel(k_set)
    fprintf('k=%+d : %.3e\n', k_set(i), Sk(i,f0_idx));
end
fprintf('(除 k=0 外，其余接近0，验证零点对齐)\n\n');

%------------------------------------------------------------------------------
% Figure 2: 非正交情况下的频谱（出现ICI干扰）
%------------------------------------------------------------------------------
% 对比：若 Δf 偏离 1/T（非正交），会出现非零干扰
df_bad = 0.8/T;                      % 不满足正交条件
Sk_bad0 = abs(T * sinc((f - 0*df_bad)*T));
Sk_bad1 = abs(T * sinc((f - 1*df_bad)*T));
figure(2); hold on; grid on;
plot(f/df_bad, Sk_bad0, 'b-', 'LineWidth', 1.6, 'DisplayName','S_0(f)');
plot(f/df_bad, Sk_bad1, 'r-', 'LineWidth', 1.6, 'DisplayName','S_1(f)');
xlabel('f / \Delta f_{bad}'); ylabel('|S_k(f)|');
title('非正交示例：\Delta f \neq 1/T 导致零点不再对齐 → ICI');
legend('show');


