### test3.m 使用说明（README）

`test3.m` 为 OFDM 链路仿真脚本（16QAM → IFFT → CP/加窗 → AWGN → 去CP/FFT → 解调/BER）。当前参数采用 15 kHz 子载波间隔、15.36 MHz 采样率、1024 点 IFFT，频域采用厄米共轭对称映射（DC=0），并将仿真符号数设为 100。**本脚本采用 LTE 风格的升余弦加窗和符号间重叠相加机制，用于降低频谱旁瓣和带外辐射。** **重要特性：接收端使用 Welch 周期图算法进行功率谱估计，相比传统 Periodogram 方法具有更低的估计方差和更好的平滑性。**

---

### 快速运行

1. 在 MATLAB 中将当前路径切换到脚本所在目录。
2. 运行：
   ```matlab
   test3
   ```
3. 脚本将自动生成 13 个 Figure 图形，并在命令行输出仿真摘要和 BER-SNR 曲线数据。

---

### 关键参数（与含义）

#### 基本时间/频率与调制参数
- `subcarrier_spacing = 15e3`：子载波间隔 15 kHz（符合 LTE 标准）
- `fs = 15.36e6`：采样频率 15.36 MHz
- `symbol_duration = 1/subcarrier_spacing`：有效符号时长约 66.67 μs
- `modulation_order = 16`，`bits_per_symbol = 4`：16QAM 调制，每子载波承载 4 比特

#### IFFT 与数据规模参数
- `IFFT_bin_length = 1024`：IFFT 点数（记为 N）
- `carrier_count = 300`：仅正频率数据子载波数量（负频率由其镜像共轭生成）
  - 占用子载波（含 DC）= 2×300 + 1 = **601**
  - 保护子载波数 = 1024 − 601 = **423**
- `total_symbols = 100`：仿真符号数（用于串行拼接并加噪分析）
- `symbols_per_frame = 50`：每帧包含的 OFDM 符号数（便于按帧组织串行信号，与窗/重叠逻辑配合）

#### CP/加窗参数（LTE 风格，重点）
- **循环前缀（CP）**：
  - `PrefixRatio = 72/1024`：循环前缀比例（GI/N）
  - `GI = 72`：固定CP长度（样本数）
  - CP 的作用：对抗多径干扰，保持符号间正交性

- **升余弦加窗（LTE 风格）**：
  - `beta = 1/16`：加窗滚降系数（过渡带占比，越小过渡越短）
  - `GIP = beta*(N+GI) = 1/16*(1024+72) = 68.5`：右端后缀长度（配合窗的尾部过渡）
  - `GIP = min(GIP, GI)`：LTE 要求，后缀长度不超过 CP 长度，确保重叠区域在 CP 内
  - 最终 `GIP = 68`（因为 68.5 < 72，取整后为68）
  - 单个符号的时域结构：`[CP(GI=72) | 主体(N=1024) | 后缀(GIP=68)]`，总长度 = **1164** 样本

- **符号间重叠相加机制**：
  - 当前符号的后缀（GIP=68 个样本）与下一个符号的 CP 前 68 个样本重叠相加
  - 重叠区域严格限制在 CP 内（68 ≤ 72），因此不影响有效数据（主体部分）
  - 接收端去除 CP 时只取主体部分，不受重叠影响

#### 信道与性能评估参数
- `targetSNRdB = 15`：目标信噪比（dB），用于 15 dB 下的详细分析
- BER-SNR 曲线计算范围：10-30 dB，步进 2 dB（共 11 个 SNR 点）

#### 随机性与可复现性
- 默认：`rng('default'); rng('shuffle');` 每次运行产生不同比特与噪声
- 复现实验：可改为 `rng(固定种子,'twister');` 后再运行

---

### 子载波的 IFFT 点数分配（频域映射，N=1024）

为生成实值时域信号，脚本采用"厄米共轭对称"频谱，并将 DC（直流）置零。采用"正频率放数据、负频率放镜像"的通用映射方式：

#### 1) 子载波组织
- **正频率数据子载波数量**：`carrier_count = 300`
- **负频率子载波**：为正频率的镜像共轭，不携带独立数据（满足 `X[k] = conj(X[N-k+2])`）
- **DC（直流）bin**：置 0
- **未占用的 bin**：置 0（保护带/空子载波）

#### 2) MATLAB IFFT bin（从 1 开始）的典型分布
- **正频率数据子载波 bin**：以系统居中方式放置在 N/4 附近的连续 300 个位置
  - 计算公式：`carriers = (1:carrier_count) + (floor(N/4)-floor(carrier_count/2))`
- **负频率镜像 bin**：`conjugate_carriers = N - carriers + 2`
- **DC bin = 1**：置 0

#### 3) 频域矩阵构造
- 将一符号的 300 个复数据载波写入正频率 `carriers`
- 将其"镜像共轭"写入 `conjugate_carriers`，满足 `X[k] = conj(X[N-k+2])`
- IFFT 后得到"近似实值"时域符号（考虑数值误差，脚本中按需取实部处理）

#### 4) 占用与保护带（按当前参数）
- **占用子载波（含 DC）**：601
- **保护子载波**：423（其余 bin）

---

### 发送端到接收端流程详解

#### 【发送端处理流程】

1. **随机比特流生成**
   - 生成 `baseband_out_length = carrier_count * total_symbols * bits_per_symbol = 300 * 100 * 4 = 120,000` 比特

2. **16QAM 调制**
   - 调用 `qam16()` 函数将比特流映射为复值符号
   - 每个符号对应 4 比特，共 30,000 个复值符号
   - 重塑为 `[total_symbols × carrier_count]` 矩阵

3. **频域子载波映射（构造厄米共轭对称）**
   - 将复值符号写入正频率 `carriers` 位置
   - 将共轭镜像写入负频率 `conjugate_carriers` 位置
   - DC bin 置 0，其余 bin 置 0（保护带）

4. **IFFT 变换（频域 → 时域）**
   - 对每个符号进行 1024 点 IFFT，得到时域 OFDM 符号（未加保护间隔）

5. **添加循环前缀（CP）与后缀**
   - 符号主体部分（中间）：1024 个样本
   - 循环前缀：将符号尾部 72 个样本复制到开头
   - 后缀：将符号头部 68 个样本复制到末尾（用于窗的右侧过渡）
   - 符号结构：`[CP(72) | 主体(1024) | 后缀(68)]`

6. **OFDM 符号加窗处理（LTE 风格）**
   - 生成升余弦窗函数：`rcos_win = rcoswindow(beta, N+GI)`，只取前 N+GI 个元素
   - 对每个符号的前 `N+GI` 个样本（CP+主体）应用升余弦窗
   - 后缀部分（GIP=68）保持原值，不加窗（用于与下一个符号的 CP 重叠）

7. **生成发送信号，并串变换（按帧组织，LTE 风格重叠相加）**
   - 按帧组织：每帧包含 50 个符号
   - **重叠相加机制**：
     - 第一个符号：完整写入（包含 CP+主体+后缀）
     - 后续符号：当前符号的后缀（GIP=68）与下一个符号的 CP 前 68 个样本重叠相加
     - 重叠区域限制在 CP 内，不影响有效数据
   - 每帧串行长度：`frame_len_CP_suffix = symbols_per_frame*(N+GI) + GIP = 50*(1024+72) + 68 = 54,868` 样本

#### 【信道传输】

8. **AWGN 加性高斯白噪声信道**
   - 根据目标 SNR（15 dB）和发送信号功率计算噪声方差
   - 添加高斯白噪声：`Rx_data = Tx_data + noise`

#### 【接收端处理流程】

9. **串并转换，去除循环前缀和后缀（LTE 风格）**
   - 按帧切分接收信号
   - 对每个符号：提取 `[CP(GI=72) | 主体(N=1024) | 后缀(GIP=68)]` 结构
   - **去除 CP 和后缀**：只保留主体部分（N=1024 个样本）进行 FFT 解调
   - 重叠区域在 CP 内，去除 CP 后不影响有效数据

10. **FFT 解调（时域 → 频域），提取子载波数据**
    - 对每个符号的主体部分（1024 点）进行 FFT
    - 提取正频率 `carriers` 位置的子载波数据

11. **16QAM 解调（最小欧氏距离判决）**
    - 调用 `demoduqam16()` 函数进行解调判决
    - 将复值符号映射回比特流

12. **误码率计算**
    - 对比发送和接收比特流，计算误码率（BER）
    - 在 15 dB SNR 下进行详细分析
    - 在 10-30 dB 范围内（步进 2 dB）计算 BER-SNR 曲线

---

### 主要图形输出（13 个 Figure）

#### 【一】单符号分析与可视化
- **Figure 1**：IFFT 各频点幅度
  - 展示激活的子载波与其共轭镜像的幅度分布
  - 可直观看到载波分配与未用频点（幅度为 0）

- **Figure 2**：IFFT 各频点相位（度）
  - 体现共轭映射带来的相位对称性
  - 验证实值时域信号条件

- **Figure 3**：单符号时域（未加 CP/后缀）
  - 展示 IFFT 输出的一个符号周期包络与幅度范围

- **Figure 4**：单符号时域（加 CP 与后缀）
  - 左侧 CP（256 样本）、右端后缀（80 样本）
  - 观察边沿延拓

- **Figure 5**：单符号时域（加窗后）
  - LTE 风格：升余弦窗平滑边沿，降低频谱旁瓣
  - 窗函数应用于 CP+主体部分，后缀部分用于与下一个符号的 CP 重叠

#### 【二】帧级、串行信号与频谱分析
- **Figure 6**：串行发送时域对比
  - 子图(1)：将每个符号（含 CP/后缀）直接串接
  - 子图(2)：仅在每帧末尾添加一次后缀的加窗串行（LTE 风格重叠相加）

- **Figure 7**：加窗前后局部窗口时域对比（与 Figure 12 相同范围）
  - 展示加窗前后信号在局部窗口内的时域波形
  - 便于观察窗函数对信号边缘的平滑作用

- **Figure 8**：加窗前后局部窗口频域对比（与 Figure 12 相同范围，双边谱）
  - 展示加窗前后信号在局部窗口内的幅度谱（dB 值）
  - 用于对比加窗对旁瓣的抑制效果

#### 【三】信道影响与接收端评估
- **Figure 12**：局部窗口时域对比（含 SNR/MSE 命令行打印）
  - 子图(1)：发送信号（局部放大）
  - 子图(2)：接收信号（局部放大）
  - 命令行输出：窗口范围、信号功率、噪声功率、SNR、MSE

- **Figure 13**：局部窗口双边谱对比（使用 Welch 方法估计功率谱）
  - 子图(1)：发送信号功率谱（Welch算法，双边谱，局部放大）
  - 子图(2)：接收信号功率谱（Welch算法，均衡前，局部放大）
  - 子图(3)：接收信号功率谱（Welch算法，均衡后，局部放大，如果使用导频均衡）

- **Figure 16**：功率谱估计方法对比（Welch vs Periodogram）
  - 子图(1)：发送信号功率谱对比（全频段）
  - 子图(2)：接收信号功率谱对比（均衡前）
  - 子图(3)：局部放大对比（显示平滑性差异）
  - 子图(4)：方差对比（柱状图，量化两种方法的方差差异）

#### 【四】解调判决与性能
- **Figure 9**：接收端 16QAM 星座图（IQ 平面）
  - SNR 越高散点越集中于 16QAM 理想点

- **Figure 10**：比特流发/收前 100 位对比
  - 子图(1)：发送比特流（前 100 位）
  - 子图(2)：接收比特流（前 100 位）

- **Figure 11**：BER-SNR 曲线（10-30 dB，步进 2 dB）
  - 对数坐标显示误码率性能
  - 包含 11 个 SNR 点的 BER 计算结果

---

### 功率谱估计方法：Welch 周期图算法

**本脚本使用 Welch 方法进行功率谱估计，相比传统 Periodogram 方法具有以下优势：**

#### Welch 方法特点
- **算法步骤**：
  1. 数据分段：将信号分成 L 段，每段长度 M_seg=256，重叠 K_overlap=128（50%重叠）
  2. 加窗处理：对每段应用 Hamming 窗，抑制频谱泄漏
  3. 计算周期图：对每段进行 FFT，计算功率谱 P_l = |X_l|² / (M_seg * U)
  4. 平均平滑：对所有周期图求平均，得到最终功率谱估计

- **优势**：
  - ✓ 估计方差低：Var[P_welch] ≈ Var[P_periodogram] / L（降低约 L 倍）
  - ✓ 平滑性好：通过平均减少功率谱波动
  - ✓ 频谱泄漏小：Hamming 窗抑制旁瓣
  - ✓ 适合噪声信号：在低 SNR 环境下表现更好

- **参数**：
  - 子段长度：M_seg = 256 样本
  - 重叠长度：K_overlap = 128 样本（50%重叠）
  - 分段数：L ≈ (N - K) / (M - K)，根据信号长度自动计算
  - 窗函数归一化因子：U = mean(hamming_win²)

#### 方法对比
- **原 Periodogram 方法**：单次 FFT，归一化幅度谱，方差大，波动明显
- **Welch 方法**：分段平均，真实功率谱密度，方差小，平滑稳定
- **Figure 16** 直观展示两种方法的差异，包括平滑性对比和方差量化

### 命令行输出信息

脚本运行时会输出以下关键信息：

1. **Welch 周期图算法参数**：
   - 信号长度、子段长度、重叠长度、分段数
   - FFT 点数、窗函数归一化因子、频率分辨率

2. **功率谱估计方法对比说明**：
   - 原 Periodogram 方法 vs Welch 方法的详细对比
   - 方差对比、频率分辨率对比、计算复杂度对比

3. **功率谱估计方差对比（数值）**：
   - 发送信号和接收信号的方差对比
   - 方差降低倍数

4. **局部窗口指标（Figure 12）**：
   - 窗口范围、长度
   - 信号功率、噪声功率
   - SNR（Tx vs Rx）、MSE（Tx vs Rx）

5. **仿真摘要（SNR = 15 dB）**：
   - 总符号数、总比特数
   - BER（15 dB 下的误码率）
   - 发送功率、噪声方差
   - IFFT 长度、激活子载波数
   - 占用子载波（含 DC）、保护子载波
   - CP 长度（GI）、后缀长度（GIP）
   - 单个 OFDM 符号长度（N+GI+GIP）
   - 窗滚降系数、重叠长度

6. **BER-SNR 曲线计算过程**：
   - 逐个 SNR 点（10-30 dB，步进 2 dB）的 BER 计算结果

---

### 关键特性说明

#### 1. LTE 风格加窗的优势
- **抑制符号边缘陡峭跳变**：升余弦窗平滑符号起止边缘
- **减少带外辐射**：降低频谱旁瓣，减少频谱泄露
- **符号间平滑过渡**：重叠相加机制确保符号连接处无突变

#### 2. 重叠相加机制的安全性
- **重叠区域限制在 CP 内**：GIP ≤ GI（80 ≤ 256），确保重叠不影响有效数据
- **接收端不受影响**：去除 CP 时只取主体部分，重叠区域被丢弃
- **不影响符号正交性**：重叠只在 CP 范围内，主体部分保持完整

#### 3. 参数选择的影响
- **CP 长度（GI）**：越长抗多径能力越强，但开销越大
- **窗滚降系数（beta）**：越小过渡越短，但可能影响平滑效果
- **后缀长度（GIP）**：受限于 CP 长度，用于控制重叠区域大小

---

### 小贴士

- **想要更快运行**：减少 `total_symbols` 或关闭部分绘图（注释掉 figure 相关代码）
- **想要更稳定的 BER 统计**：增大 `total_symbols`（运行时间相应增加）
- **想要对比加窗效果**：可修改 `beta = 0` 和 `GIP = 0` 来关闭加窗，对比频谱变化
- **想要复现实验**：将 `rng('default'); rng('shuffle');` 改为 `rng(固定种子,'twister');`
- **想要调整 CP 长度**：修改 `PrefixRatio` 值（注意 GIP 会相应变化，但受限于 GI）
- **想要观察重叠效果**：查看 Figure 6 的上下子图对比，以及 Figure 7/8 的加窗前后对比

---

### 扩展建议

如需扩展功能，可在现有结构上逐步添加：
- **多径信道**：在 AWGN 信道后添加多径衰落模型
- **信道均衡**：在 FFT 解调后添加均衡器（如 MMSE、ZF）
- **信道编码/交织**：在 16QAM 调制前添加编码，在解调后添加解码
- **同步**：添加符号同步、频率同步模块
- **其他调制方式**：修改 `qam16()` 和 `demoduqam16()` 调用，支持 QPSK、64QAM 等

祝你仿真顺利！
